<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Price-IQ</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1216; --panel:#171b21; --muted:#202532; --text:#e7edf3; --sub:#9fb0c3;
    --accent:#7bd7ff; --ok:#27d980; --warn:#ffd166; --danger:#ff6b6b;
    --chip:#222838; --chipStroke:#2b3143; --chipText:#cfd9e5;
    --row:#12161c; --rowAlt:#141922; --badge:#283042;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  header h1{font-size:26px;margin:0}
  .updated{margin-left:auto;font-size:12px;color:var(--sub);background:var(--panel);border:1px solid var(--chipStroke);padding:6px 10px;border-radius:10px}
  .row{display:grid;gap:12px}
  .hero{grid-template-columns:1.1fr 1fr 1fr 1fr 1fr 110px}
  .tileRow{grid-template-columns:repeat(4,1fr)}
  @media (max-width:980px){ .hero{grid-template-columns:1fr 1fr} .tileRow{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
  .select, .btn, .inp{width:100%;appearance:none;background:var(--chip);border:1px solid var(--chipStroke);color:var(--text);padding:10px 12px;border-radius:10px}
  .btn{cursor:pointer}
  .btn.clear{background:#1d2430;border-color:#2a3244}
  .stat{display:flex;flex-direction:column;gap:6px}
  .stat h4{margin:0;color:var(--sub);font-weight:600}
  .stat .val{font-size:28px;font-weight:700}
  .stat .sub{color:var(--sub);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);color:var(--sub);font-size:12px;border:1px solid var(--chipStroke)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{color:var(--sub);font-weight:600;text-align:left;font-size:12px;padding:0 10px 6px}
  tbody tr{background:var(--row);border:1px solid var(--muted)}
  tbody tr:nth-child(even){background:var(--rowAlt)}
  td{padding:12px 10px;vertical-align:middle}
  td .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chipStroke);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--chipText)}
  .right{text-align:right}
  .sectionTitle{display:flex;align-items:center;gap:10px;margin:18px 4px 8px}
  .small{font-size:12px;color:var(--sub)}
  .debug{display:none}
  .debug.on{display:block}
  .controls{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  /* nicer selects */
  .select{outline:none;transition:border-color .12s ease}
  .select:focus{border-color:#3b82f6}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Price-IQ</h1>
      <span class="small">Auto-generated from <code>docs/data/derived/</code></span>
      <div class="updated" id="asOf">Updated: —</div>
    </header>

    <!-- CLEAN HERO FILTERS (default to H100 / On-Demand / 1h if available) -->
    <div class="row hero">
      <select id="f_gpu" class="select" title="GPU"></select>
      <select id="f_type" class="select" title="Type"></select>
      <select id="f_region" class="select" title="Region"></select>
      <select id="f_duration" class="select" title="Duration"></select>
      <select id="f_count" class="select" title="GPU Count"></select>
      <button class="btn clear" id="btnClear">Clear</button>
    </div>

    <!-- KPI TILES -->
    <div class="row tileRow" style="margin-top:12px">
      <div class="card stat"><h4>Cheapest / GPU-hr</h4><div class="val" id="kpi_low">–</div><div class="sub" id="kpi_low_sub"></div></div>
      <div class="card stat"><h4>Median / GPU-hr</h4><div class="val" id="kpi_med">–</div><div class="sub" id="kpi_med_sub"></div></div>
      <div class="card stat"><h4>Providers covered</h4><div class="val" id="kpi_prov">–</div><div class="sub" id="kpi_prov_sub">Unique providers in view</div></div>
      <div class="card stat"><h4>Entries</h4><div class="val" id="kpi_rows">0</div><div class="sub">Rows in leaderboard</div></div>
    </div>

    <!-- DATA STATUS (toggle) -->
    <div class="sectionTitle" style="margin-top:18px">
      <div class="switch small">
        <input type="checkbox" id="toggleDebug">
        <label for="toggleDebug">Show data status (debug)</label>
      </div>
    </div>
    <div class="card debug" id="debugPanel"><div id="debugLines" class="small"></div></div>

    <!-- LEADERBOARD -->
    <div class="sectionTitle"><h3 style="margin:0">Leaderboard (Price-IQ)</h3><span class="small" id="lbSort">Sorted by price ↑</span></div>
    <div class="card">
      <table id="tbl_leader">
        <thead><tr>
          <th>Provider</th><th>Region</th><th>GPU</th><th>Type</th>
          <th>Duration</th><th>Count</th>
          <th class="right">$/GPU-hr</th><th class="right">Score</th><th class="right">Timestamp</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ROI -->
    <div class="sectionTitle"><h3 style="margin:0">ROI (Cheapest total cost)</h3><span class="small">from <code>roi_comparison.csv</code></span></div>
    <div class="card">
      <table id="tbl_roi">
        <thead><tr>
          <th>GPU</th><th>Count</th><th>Duration</th><th>Provider</th>
          <th>Region</th><th class="right">$/GPU-hr</th><th class="right">Total cost</th><th class="right">When</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- QUICK CALC -->
    <div class="sectionTitle"><h3 style="margin:0">ROI Calculator (quick)</h3></div>
    <div class="card">
      <div class="controls" style="flex-wrap:wrap;margin-bottom:10px">
        <select id="qc_gpu" class="select" style="min-width:160px"></select>
        <select id="qc_region" class="select" style="min-width:160px"></select>
        <select id="qc_count" class="select" style="min-width:120px"></select>
        <select id="qc_dur" class="select" style="min-width:160px"></select>
        <label class="switch small"><input type="checkbox" id="qc_usePred"> Use predictions (P50) if available</label>
        <button class="btn" id="btnCalc">Calculate</button>
      </div>
      <table id="tbl_qc">
        <thead><tr><th>Provider</th><th>Region</th><th class="right">$/GPU-hr</th><th class="right">Total cost</th><th class="right">Source</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row tileRow" style="margin-top:12px">
        <div class="card stat"><h4>Predicted price (P10)</h4><div class="val" id="p10">–</div></div>
        <div class="card stat"><h4>Predicted price (P25)</h4><div class="val" id="p25">–</div></div>
        <div class="card stat"><h4>Predicted price (P50)</h4><div class="val" id="p50">–</div></div>
        <div class="card stat"><h4>Predicted price (P75 / P90)</h4><div class="val" id="p7590">– / –</div></div>
      </div>
    </div>

    <!-- FORECAST (30-day Prophet) -->
    <div class="sectionTitle"><h3 style="margin:0">Forecast (30 days)</h3><span class="small">from <code>forecast.csv</code></span></div>
    <div class="card"><canvas id="forecastChart" height="120"></canvas></div>

    <p class="small" style="margin:16px 4px 40px">
      Tip: data loads from <code>docs/data/derived/*.csv</code>. If a section is empty, check your CI run & artifact paths.
    </p>
  </div>

<script>
(function(){
  // ---------- helpers ----------
  const fmt = {
    money:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(2)}`,
    money0:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(0)}`,
    num:n  => n==null||isNaN(n) ? '–' : Number(n).toLocaleString(),
    date:s => s? String(s).replace('T',' ').replace('Z',''): '–'
  };
  const parseCSV=(txt)=>{
    const lines=txt.trim().split(/\r?\n/);
    const cols=lines.shift().split(",").map(h=>h.trim());
    return lines.filter(Boolean).map(line=>{
      const cells=line.split(",").map(s=>s.trim());
      const obj={}; cols.forEach((c,i)=>obj[c]=cells[i]??"");
      return obj;
    });
  };
  const uniq = arr => [...new Set(arr)];
  const byNumAsc = key => (a,b)=> (+a[key]||1e9)-(+b[key]||1e9);
  const norm = s => (s||"").toLowerCase().replace(/[^a-z0-9]/g,"");

  const PATH = "docs/data/derived/";
  const files = {
    scores : "provider_scores_latest.csv",
    roi    : "roi_comparison.csv",
    predict: "price_predict_snapshot.json",   // optional
    snap   : "compute_calculator_snapshot.csv",
    forecast: "forecast.csv"
  };

  async function get(path){
    const res = await fetch(PATH + path, {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    return res;
  }

  const state = {
    scores:[], roi:[], predict:null, snap:[],
    filters: {gpu:"All", region:"All", type:"On-Demand", duration:"All", count:"All"}
  };

  function numify(x){ if(x==null) return NaN; return Number(String(x).replace(/[^\d.\-]/g,"")); }

  // ---------- load derived files ----------
  async function loadAll(){
    const debug=[];

    // Scores
    try{
      const txt = await (await get(files.scores)).text();
      const rows = parseCSV(txt).map(r=>({
        provider:r.provider, provider_key:norm(r.provider),
        region:r.region, gpu:r.gpu_model, type:r.type, duration:r.duration,
        count: r.gpu_count ? Number(r.gpu_count) : null,
        price: numify(r.effective_price_usd_per_gpu_hr),
        score: r.priceiq_score ? Number(r.priceiq_score) : null,
        ts: r.timestamp
      })).filter(r=>isFinite(r.price));
      state.scores = rows;
      debug.push(`✅ Loaded ${files.scores} (${rows.length} rows)`);
    }catch(e){ debug.push(`⚠️ Failed ${files.scores}`); }

    // ROI
    try{
      const txt = await (await get(files.roi)).text();
      const rows = parseCSV(txt).map(r=>({
        gpu:r.gpu_model, count:Number(r.gpu_count), duration:r.duration,
        provider:r.best_provider, region:r.best_region,
        p: Number(r.price_per_gpu_hr), total:Number(r.total_cost_usd), ts:r.timestamp
      }));
      state.roi = rows; debug.push(`✅ Loaded ${files.roi} (${rows.length} rows)`);
    }catch(e){ debug.push(`⚠️ Failed ${files.roi}`); }

    // Optional predict snapshot
    try{
      state.predict = await (await get(files.predict)).json();
      debug.push(`✅ Loaded ${files.predict}`);
    }catch(e){ debug.push(`ℹ️ ${files.predict} not found (ok)`); }

    // Snapshot
    try{
      const txt = await (await get(files.snap)).text();
      state.snap = parseCSV(txt); debug.push(`✅ Loaded ${files.snap} (${state.snap.length} rows)`);
    }catch(e){ debug.push(`⚠️ Failed ${files.snap}`); }

    document.getElementById("debugLines").innerHTML = debug.map(s=>`<div>${s}</div>`).join("");

    initFilters();
    hydrateAll();
  }

  // ---------- filters ----------
  function setOptions(el, arr, withAll=true){
    el.innerHTML=""; const vals = withAll? ["All",...arr]: arr;
    for(const v of vals){ const o=document.createElement("option"); o.value=v; o.textContent=v; el.appendChild(o); }
  }

  function initFilters(){
    const gpuSel     = document.getElementById("f_gpu");
    const typeSel    = document.getElementById("f_type");
    const regionSel  = document.getElementById("f_region");
    const durSel     = document.getElementById("f_duration");
    const countSel   = document.getElementById("f_count");

    const gpus = uniq(state.scores.map(r=>r.gpu)).sort();
    const types= uniq(state.scores.map(r=>r.type)).sort();
    const regs = uniq(state.scores.map(r=>r.region)).sort();
    const durs = uniq(state.scores.map(r=>r.duration)).sort();

    setOptions(gpuSel, gpus);
    setOptions(typeSel, types);
    setOptions(regionSel, regs);
    setOptions(durSel, durs);
    setOptions(countSel, uniq(state.scores.map(r=>r.count).filter(Boolean)).sort((a,b)=>a-b));

    // sensible defaults
    gpuSel.value = gpus.includes("H100") ? "H100" : (gpus[0] || "All");
    typeSel.value = types.includes("On-Demand") ? "On-Demand" : (types[0] || "All");
    durSel.value = durs.includes("1h") ? "1h" : (durs.includes("1 hour") ? "1 hour" : "All");
    regionSel.value = "All"; countSel.value = "All";
    state.filters={gpu:gpuSel.value, type:typeSel.value, region:"All", duration:durSel.value, count:"All"};

    [gpuSel,typeSel,regionSel,durSel,countSel].forEach((el,i)=>{
      const keys=["gpu","type","region","duration","count"]; const k=keys[i];
      el.addEventListener("change", ()=>{ state.filters[k]=el.value; hydrateAll(); loadForecast(); });
    });
    document.getElementById("btnClear").onclick=()=>{
      gpuSel.value = gpus.includes("H100") ? "H100" : (gpus[0] || "All");
      typeSel.value = types.includes("On-Demand") ? "On-Demand" : (types[0] || "All");
      regionSel.value="All"; durSel.value = durs.includes("1h") ? "1h" : (durs.includes("1 hour") ? "1 hour" : "All"); countSel.value="All";
      state.filters={gpu:gpuSel.value,type:typeSel.value,region:"All",duration:durSel.value,count:"All"};
      hydrateAll(); loadForecast();
    };

    // Updated time → latest timestamp from scores
    const latest = state.scores.map(r=>r.ts).filter(Boolean).sort().pop();
    document.getElementById("asOf").textContent = "Updated: " + (latest ? fmt.date(latest) : new Date().toISOString().replace('T',' ').replace('Z',''));
  }

  function applyFilters(rows){
    const f=state.filters;
    return rows.filter(r=>
      (f.gpu==="All"||r.gpu===f.gpu) &&
      (f.region==="All"||r.region===f.region) &&
      (f.type==="All"||r.type===f.type) &&
      (f.duration==="All"||r.duration===f.duration) &&
      (f.count==="All"|| String(r.count)===String(f.count))
    );
  }

  // ---------- UI populate ----------
  function hydrateAll(){
    const rows = applyFilters(state.scores).sort(byNumAsc("price"));
    document.getElementById("kpi_rows").textContent = rows.length;

    if(rows.length){
      const lo = rows[0];
      document.getElementById("kpi_low").textContent = fmt.money(lo.price);
      document.getElementById("kpi_low_sub").textContent = `${lo.provider} · ${lo.region} · ${lo.gpu} (${lo.type})`;
      const prices = rows.map(r=>r.price).filter(x=>isFinite(x)).sort((a,b)=>a-b);
      const mid = prices[Math.floor(prices.length/2)];
      document.getElementById("kpi_med").textContent = fmt.money(mid);
      document.getElementById("kpi_med_sub").textContent = `${rows.length} quotes`;
      const provs = uniq(rows.map(r=>r.provider)).length;
      document.getElementById("kpi_prov").textContent = provs;
    }else{
      ["kpi_low","kpi_med","kpi_prov"].forEach(id=>document.getElementById(id).textContent="–");
      document.getElementById("kpi_low_sub").textContent="";
      document.getElementById("kpi_med_sub").textContent="";
    }

    const tbody=document.querySelector("#tbl_leader tbody");
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.provider}</td>
        <td>${r.region}</td>
        <td>${r.gpu}</td>
        <td><span class="pill">${r.type}</span></td>
        <td>${r.duration||"–"}</td>
        <td>${r.count!=null? r.count : "–"}</td>
        <td class="right">${fmt.money(r.price)}</td>
        <td class="right">${r.score!=null? Number(r.score).toFixed(1):"–"}</td>
        <td class="right">${fmt.date(r.ts)}</td>
      </tr>`).join("");

    const rbody=document.querySelector("#tbl_roi tbody");
    rbody.innerHTML = state.roi.map(r=>`
      <tr>
        <td>${r.gpu}</td><td>${r.count}</td><td>${r.duration}</td>
        <td>${r.provider}</td><td>${r.region}</td>
        <td class="right">${fmt.money(r.p)}</td>
        <td class="right">${fmt.money0(r.total)}</td>
        <td class="right">${fmt.date(r.ts)}</td>
      </tr>`).join("");
  }

  // ---------- quick calc ----------
  function toHours(s){
    if(!s) return NaN; s=String(s).toLowerCase().trim();
    const m=s.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)$/); if(!m) return NaN;
    const q=parseFloat(m[1]), u=m[2];
    const mult={h:1,hr:1,hour:1,d:24,day:24,w:168,wk:168,week:168,mo:720,month:720}[u] ?? NaN;
    return q*mult;
  }
  function runQuickCalc(){
    const gpu  = document.getElementById("qc_gpu").value;
    const reg  = document.getElementById("qc_region").value;
    const cnt  = Number(document.getElementById("qc_count").value);
    const durS = document.getElementById("qc_dur").value;
    const hours= toHours(durS) || 0;
    const usePred = document.getElementById("qc_usePred").checked;

    let rows = state.scores.filter(r=> r.gpu===gpu && r.region===reg && /On-Demand/i.test(r.type));
    const byProv=new Map();
    rows.forEach(r=>{
      const key=r.provider+"|"+r.region;
      const best=byProv.get(key);
      if(!best || r.price<best.price) byProv.set(key,r);
    });

    let out=[...byProv.values()].map(r=>({provider:r.provider,region:r.region,price:r.price,total:r.price*cnt*hours,src:"observed"}));

    if(usePred && state.predict && state.predict.gpu_model===gpu && state.predict.region===reg && state.predict.p50){
      out.push({provider:"Predicted (P50)", region:reg, price:Number(state.predict.p50), total:Number(state.predict.p50)*cnt*hours, src:"predicted"});
    }

    out.sort((a,b)=>a.total-b.total);
    document.querySelector("#tbl_qc tbody").innerHTML = out.map(r=>`
      <tr><td>${r.provider}</td><td>${r.region}</td>
      <td class="right">${fmt.money(r.price)}</td>
      <td class="right">${fmt.money0(r.total)}</td>
      <td class="right"><span class="badge">${r.src}</span></td></tr>`).join("");
  }
  document.getElementById("btnCalc").addEventListener("click", runQuickCalc);

  // ---------- forecast chart ----------
  async function loadForecast(){
    let txt;
    try{ txt = await (await get(files.forecast)).text(); }
    catch(e){ console.log("⚠️ forecast.csv not found", e); return; }

    const rows = parseCSV(txt).map(r=>({
      date:r.date, pred:+r.pred, pred_lo:+r.pred_lo, pred_hi:+r.pred_hi,
      provider:r.provider, provider_key:norm(r.provider),
      gpu:r.gpu_model, type:r.type, duration:r.duration, region:r.region
    }));

    // choose series: cheapest provider in current view (so chart always relevant)
    const current = applyFilters(state.scores).sort(byNumAsc("price"))[0];
    let series = [];
    if(current){
      const key = current.provider_key || norm(current.provider);
      series = rows.filter(r =>
        r.provider_key===key &&
        (state.filters.gpu==="All"|| r.gpu===state.filters.gpu) &&
        (state.filters.type==="All"|| r.type===state.filters.type) &&
        (state.filters.duration==="All"|| r.duration===state.filters.duration)
      );
    }
    // fallback: any provider matching GPU/type/duration
    if(!series.length){
      series = rows.filter(r =>
        (state.filters.gpu==="All"|| r.gpu===state.filters.gpu) &&
        (state.filters.type==="All"|| r.type===state.filters.type) &&
        (state.filters.duration==="All"|| r.duration===state.filters.duration)
      );
    }
    // final fallback: common default
    if(!series.length){
      series = rows.filter(r => r.gpu==="H100" && r.type==="On-Demand" && (r.duration==="1h" || r.duration==="1 hour"));
    }
    if(!series.length){ console.log("No forecast series matched filters"); return; }

    // aggregate by date (median), sort, then plot
    const byDate = {};
    series.forEach(r=>{ (byDate[r.date]??=[]).push(r); });
    const dates = Object.keys(byDate).sort();
    const median = (arr, key) => {
      const a = arr.map(x=>+x[key]).filter(Number.isFinite).sort((x,y)=>x-y);
      return a.length ? a[Math.floor(a.length/2)] : null;
    };
    const preds = dates.map(d=>median(byDate[d], "pred"));
    const lo    = dates.map(d=>median(byDate[d], "pred_lo"));
    const hi    = dates.map(d=>median(byDate[d], "pred_hi"));

    const ctx = document.getElementById("forecastChart").getContext("2d");
    if(window._forecastChart) window._forecastChart.destroy();
    window._forecastChart = new Chart(ctx, {
      type:'line',
      data:{ labels:dates, datasets:[
        {label:"Forecast", data:preds, borderColor:"#60a5fa", fill:false},
        {label:"Lower", data:lo, borderColor:"#9ca3af", borderDash:[5,5], fill:false},
        {label:"Upper", data:hi, borderColor:"#9ca3af", borderDash:[5,5], fill:false},
      ]},
      options:{ responsive:true, plugins:{legend:{display:true}}, scales:{x:{}, y:{}} }
    });
  }

  // ---------- boot ----------
  loadAll().then(loadForecast);

  // debug panel toggle
  document.getElementById("toggleDebug").addEventListener("change", (e)=>{
    document.getElementById("debugPanel").classList.toggle("on", e.target.checked);
  });
})();
</script>
</body>
</html>




