<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Price-IQ</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --bg:#0f1216; --panel:#171b21; --muted:#202532; --text:#e7edf3; --sub:#9fb0c3;
    --accent:#7bd7ff; --ok:#27d980; --warn:#ffd166; --danger:#ff6b6b;
    --chip:#222838; --chipStroke:#2b3143; --chipText:#cfd9e5;
    --row:#12161c; --rowAlt:#141922; --badge:#283042;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  header h1{font-size:26px;margin:0}
  .updated{margin-left:auto;font-size:12px;color:var(--sub);background:var(--panel);border:1px solid var(--chipStroke);padding:6px 10px;border-radius:10px}
  .row{display:grid;gap:12px}
  .hero{grid-template-columns:1fr 1fr 1fr 1fr 1fr 110px}
  .tileRow{grid-template-columns:1fr 1fr 1fr 1fr}
  @media (max-width:980px){ .hero{grid-template-columns:1fr 1fr} .tileRow{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
  .select, .btn, .inp{width:100%;appearance:none;background:var(--chip);border:1px solid var(--chipStroke);color:var(--text);padding:10px 12px;border-radius:10px}
  .select{padding-right:36px;background-image:linear-gradient(45deg,transparent 50%,var(--sub) 50%),linear-gradient(135deg,var(--sub) 50%,transparent 50%),linear-gradient(to right,transparent,transparent);
          background-position:calc(100% - 18px) 16px,calc(100% - 12px) 16px,100% 0;background-size:6px 6px,6px 6px,2.5em 2.5em;background-repeat:no-repeat}
  .btn{cursor:pointer}
  .btn.clear{background:#1d2430;border-color:#2a3244}
  .stat{display:flex;flex-direction:column;gap:6px}
  .stat h4{margin:0;color:var(--sub);font-weight:600}
  .stat .val{font-size:28px;font-weight:700}
  .stat .sub{color:var(--sub);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);color:var(--sub);font-size:12px;border:1px solid var(--chipStroke)}
  .badge.best{background:rgba(39,217,128,0.12); color:#9ff3c8; border-color:rgba(39,217,128,0.25)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{color:var(--sub);font-weight:600;text-align:left;font-size:12px;padding:0 10px 6px}
  tbody tr{background:var(--row);border:1px solid var(--muted)}
  tbody tr:nth-child(even){background:var(--rowAlt)}
  td{padding:12px 10px;vertical-align:middle}
  td .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chipStroke);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--chipText)}
  .right{justify-self:end;text-align:right}
  .sectionTitle{display:flex;align-items:center;gap:10px;margin:18px 4px 8px}
  .small{font-size:12px;color:var(--sub)}
  .debug{display:none}
  .debug.on{display:block}
  .controls{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .control{display:flex;flex-direction:column;gap:6px}
  .control label{font-size:11px;color:var(--sub);padding-left:2px}
  .barWrap{margin-top:6px;height:6px;background:rgba(255,255,255,0.05);border:1px solid var(--chipStroke);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg, var(--accent), #89e1ff)}
  .roiCell{background:var(--row);border:1px solid var(--muted);border-radius:12px;padding:10px;cursor:pointer}
  .roiCell h4{margin:0 0 6px 0;font-size:13px;color:var(--sub);font-weight:600}
  .roiCell .prov{font-weight:700}
  .roiCell .total{font-size:18px;font-weight:800}
  .gridHead{color:var(--sub);font-size:12px;margin:6px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Price-IQ</h1>
      <span class="small">Auto-generated from <code>data/derived/</code></span>
      <div class="updated" id="asOf">Updated: —</div>
    </header>

    <!-- HERO FILTERS -->
    <div class="row hero">
      <div class="control"><label>GPU</label><select id="f_gpu" class="select"></select></div>
      <div class="control"><label>Region</label><select id="f_region" class="select"></select></div>
      <div class="control"><label>Type</label><select id="f_type" class="select"></select></div>
      <div class="control"><label>Duration</label><select id="f_duration" class="select"></select></div>
      <div class="control"><label>GPU Count</label><select id="f_count" class="select"></select></div>
      <div class="control"><label>&nbsp;</label><button class="btn clear" id="btnClear">Clear</button></div>
    </div>

    <!-- KPI TILES -->
    <div class="row tileRow" style="margin-top:12px">
      <div class="card stat">
        <h4>Cheapest / GPU-hr</h4>
        <div class="val" id="kpi_low">–</div>
        <div class="sub" id="kpi_low_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Median / GPU-hr</h4>
        <div class="val" id="kpi_med">–</div>
        <div class="sub" id="kpi_med_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Providers covered</h4>
        <div class="val" id="kpi_prov">–</div>
        <div class="sub" id="kpi_prov_sub">Unique provider names in current filter.</div>
      </div>
      <div class="card stat">
        <h4>Entries</h4>
        <div class="val" id="kpi_rows">0</div>
        <div class="sub">Rows displayed in leaderboard.</div>
      </div>
    </div>

    <!-- DATA STATUS -->
    <div class="sectionTitle" style="margin-top:18px">
      <div class="switch small"><input type="checkbox" id="toggleDebug"><label for="toggleDebug">Show data status (debug)</label></div>
    </div>
    <div class="card debug" id="debugPanel"><div id="debugLines" class="small"></div></div>

    <!-- LEADERBOARD -->
    <div class="sectionTitle">
      <h3 style="margin:0">Leaderboard (Price-IQ)</h3>
      <span class="small" id="lbSort">Sorted by price ↑</span>
    </div>
    <div class="card">
      <table id="tbl_leader">
        <thead>
          <tr>
            <th>Provider</th><th>Region</th><th>GPU</th><th>Type</th>
            <th>Duration</th><th>Count</th>
            <th class="right">$/GPU-hr</th><th class="right">Score</th><th class="right">Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ROI (IMPROVED GRID) -->
    <div class="sectionTitle">
      <h3 style="margin:0">ROI (Cheapest total cost)</h3>
      <span class="small">from <code>roi_comparison.csv</code></span>
    </div>
    <div class="card" id="roiCard">
      <div class="controls" style="flex-wrap:wrap;gap:8px;margin-bottom:12px">
        <div class="control"><label>GPU</label><select id="roi_gpu" class="select" style="min-width:140px"></select></div>
        <div class="control"><label>Region</label><select id="roi_region" class="select" style="min-width:140px"></select></div>
        <div class="control"><label>Metric</label>
          <select id="roi_metric" class="select" style="min-width:160px">
            <option value="total">Total cost</option>
            <option value="rate">$/GPU-hr (derived)</option>
          </select>
        </div>
        <div class="control"><label>&nbsp;</label><button id="roi_reset" class="btn clear">Reset</button></div>
      </div>

      <div class="gridHead">Click a scenario to see Top-3</div>
      <div id="roi_grid" class="row" style="gap:10px"></div>

      <div id="roi_details" class="card" style="margin-top:12px; display:none">
        <div class="sectionTitle" style="margin-top:0">
          <h3 style="margin:0" id="roi_detail_title">Top options</h3>
          <span class="small" id="roi_detail_meta"></span>
        </div>
        <table style="width:100%">
          <thead>
            <tr>
              <th>Provider</th><th>Region</th>
              <th class="right">$/GPU-hr</th>
              <th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="roi_detail_body"></tbody>
        </table>
      </div>
    </div>

    <!-- PRICE BENCHMARK -->
    <div class="sectionTitle">
      <h3 style="margin:0">Price benchmark (cross-provider)</h3>
      <span class="small">from <code>data/derived/provider_scores_latest.csv</code></span>
    </div>
    <div class="card" id="benchCard">
      <div class="row" style="grid-template-columns:320px 1fr; gap:18px">
        <div>
          <div class="control" style="margin-bottom:10px"><label>GPU</label>
            <select id="bm_gpu" class="select"><option>H100</option><option>H200</option></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Region</label>
            <select id="bm_region" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Type</label>
            <select id="bm_type" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Duration</label>
            <select id="bm_duration" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>GPU Count</label>
            <select id="bm_count" class="select"></select>
          </div>
          <button class="btn" id="bm_run">Predict price</button>
          <div class="small" id="bm_note" style="margin-top:8px;color:var(--sub)"></div>
          <div class="small" style="margin-top:8px;color:var(--sub)">Deal guidance: <span id="bm_deal" class="badge" style="display:none"></span></div>
        </div>

        <div>
          <div class="row tileRow">
            <div class="card stat"><h4>10% quantile</h4><div class="val" id="bm_p10">–</div></div>
            <div class="card stat"><h4>25% quantile</h4><div class="val" id="bm_p25">–</div></div>
            <div class="card stat"><h4>Median</h4><div class="val" id="bm_p50">–</div></div>
            <div class="card stat"><h4>75% quantile</h4><div class="val" id="bm_p75">–</div></div>
            <div class="card stat"><h4>90% quantile</h4><div class="val" id="bm_p90">–</div></div>
          </div>

          <div class="card" style="margin-top:12px;text-align:center">
            <div class="small" style="margin-bottom:6px;color:var(--sub)">Predicted price (P50)</div>
            <div style="font-size:40px;font-weight:800" id="bm_big">–</div>
          </div>

          <div class="card" style="margin-top:12px">
            <canvas id="bm_chart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- FORECAST -->
    <div class="sectionTitle">
      <h3 style="margin:0">Forecast (next 72 hours)</h3>
      <span class="small">from <code>forecast.csv</code> · <span id="fcMeta"></span></span>
    </div>
    <div class="card">
      <div class="small" id="fcNote" style="margin-bottom:8px;color:var(--sub)"></div>
      <canvas id="fc_chart" height="120"></canvas>
    </div>

    <!-- SNAPSHOT -->
    <div class="sectionTitle">
      <h3 style="margin:0">Compute Calculator Snapshot</h3>
      <span class="small">from <code>compute_calculator_snapshot.csv</code></span>
    </div>
    <div class="card">
      <table id="tbl_comp">
        <thead>
          <tr>
            <th>GPU</th><th>Provider type</th><th>$ / GPU-hr</th><th>TOTAL (term)</th>
            <th class="right">lo</th><th class="right">md</th><th class="right">hi</th>
            <th class="right">term hrs</th><th class="right">GPUs</th><th>Region</th><th class="right">#quotes</th><th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="small" style="margin:16px 4px 40px">
      Tip: serve over HTTP (e.g. <code>python -m http.server</code>). Data loads from <code>data/derived/</code>.
      Toggle debug to see which files were found.
    </p>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
(function(){
  // ---------------------- DEBUG LOGGER ----------------------
  const dbg = [];
  function logDbg(msg){
    dbg.push(msg);
    const el = document.getElementById("debugLines");
    if (el) el.innerHTML = dbg.map(s=>`<div>${s}</div>`).join("");
    console.log("[Price-IQ]", msg);
  }
  const dbgToggle = document.getElementById("toggleDebug");
  const debugPanel = document.getElementById("debugPanel");
  if (dbgToggle && debugPanel) {
    dbgToggle.addEventListener("change",(e)=>{
      debugPanel.classList.toggle("on", e.target.checked);
    });
  }

  // ---------------------- UTILS ----------------------
  const fmt = {
    money:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(2)}`,
    money0:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(0)}`,
    num:n  => n==null||isNaN(n) ? '–' : Number(n).toLocaleString(),
    date:s => s? String(s).replace('T',' ').replace('Z',''): '–'
  };
  function numify(x){ return x==null ? NaN : Number(String(x).replace(/[^\d.\-]/g,"")); }
  function parseCSV(txt){
    const lines = txt.replace(/^\uFEFF/,'').trim().split(/\r?\n/);
    if (!lines.length) return [];
    const header = lines.shift().split(",").map(h=>h.trim());
    return lines.filter(Boolean).map(line=>{
      const cells = line.split(",").map(s=>s.trim());
      const o={}; header.forEach((h,i)=>o[h]=cells[i]??"");
      return o;
    });
  }
  const uniq = arr => [...new Set(arr)];
  const byNumAsc = key => (a,b)=> (+a[key]||1e12)-(+b[key]||1e12);

  function durToHours(s){
    const v = String(s||"").toLowerCase();
    if (/month/.test(v)) return 24*30;
    if (/week/.test(v))  return 24*7;
    if (/day/.test(v))   return 24;
    return 1; // hour
  }

  // ---------------------- ROBUST PATHS ----------------------
  async function tryFetch(url){
    const bust = (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const r = await fetch(url + bust,{cache:"no-store"});
    if(!r.ok) throw new Error(r.status+" "+url);
    return r;
  }
  const DER_BASES = [
    "data/derived/","./data/derived/","../data/derived/",
    "docs/data/derived/","./docs/data/derived/","/data/derived/","/docs/data/derived/"
  ];
  async function getDerived(file){
    for(const b of DER_BASES){
      try{ const r=await tryFetch(b+file); logDbg("✅ "+b+file); return r; }catch(e){}
    }
    const msg = "❌ MISSING: "+file;
    logDbg(msg);
    throw new Error("Missing "+file);
  }

  // ---------------------- STATE ----------------------
  const state = {
    scores:[], roi:[], predict:null, snap:[], forecast:[],
    filters: {gpu:"All", region:"All", type:"On-Demand", duration:"All", count:"All"}
  };

  // ---------------------- LOAD DERIVED ----------------------
  const files = {
    scores : "provider_scores_latest.csv",
    roi    : "roi_comparison.csv",
    predict: "price_predict_snapshot.json",
    snap   : "compute_calculator_snapshot.csv",
    forecast: "forecast.csv"
  };

  async function loadAll(){
    try{
      const txt = await (await getDerived(files.scores)).text();
      state.scores = parseCSV(txt).map(r=>({
        provider:r.provider, region:r.region, gpu:r.gpu_model, type:r.type, duration:r.duration,
        count: r.gpu_count ? Number(r.gpu_count) : null,
        price: numify(r.effective_price_usd_per_gpu_hr),
        score: r.priceiq_score ? Number(r.priceiq_score) : null,
        ts: r.timestamp
      })).filter(r=>isFinite(r.price));
      logDbg(`rows(scores): ${state.scores.length}`);
    }catch(e){ logDbg("scores load error: "+e); }

    try{
      const txt = await (await getDerived(files.roi)).text();
      state.roi = parseCSV(txt).map(r=>{
        const gpu = r.gpu_model;
        const count = Number(r.gpu_count);
        const duration = r.duration;
        const hrs = durToHours(duration);
        const total = Number(r.total_cost_usd);
        const csvRate = Number(r.price_per_gpu_hr);
        // derive rate from total when possible
        const derived = (isFinite(total) && isFinite(count) && count>0 && hrs>0)
          ? (total / (count * hrs))
          : NaN;
        // if CSV rate exists but differs >1% from derived, trust derived
        let p_eff = isFinite(derived) ? derived : csvRate;
        if (isFinite(csvRate) && isFinite(derived)){
          const diff = Math.abs(csvRate - derived) / Math.max(derived,1e-9);
          if (diff <= 0.01) p_eff = csvRate; // within 1%, keep csv
          else p_eff = derived;               // else use derived (fix bad CSV)
        }
        return {
          gpu,
          count,
          duration,
          provider:r.best_provider,
          region:r.best_region,
          p_csv: csvRate,
          p_eff,                // corrected $/GPU-hr to display/use
          total,
          hrs,
          ts:r.timestamp
        };
      }).filter(r=>isFinite(r.total));
      logDbg(`rows(roi): ${state.roi.length}`);
    }catch(e){ logDbg("roi load error: "+e); }

    try{
      state.predict = await (await getDerived(files.predict)).json();
      logDbg("predict: ok");
    } catch(e){ logDbg("predict not found (ok)"); }

    try{
      const txt = await (await getDerived(files.snap)).text();
      state.snap = parseCSV(txt);
      logDbg(`rows(snapshot): ${state.snap.length}`);
    }catch(e){ logDbg("snapshot load error: "+e); }

    try{
      const txt = await (await getDerived(files.forecast)).text();
      state.forecast = parseCSV(txt).map(r=>({
        gpu:r.gpu_model, region:r.region, type:r.type, duration:r.duration, count:Number(r.gpu_count),
        date:r.date_utc || r.date || r.ts, h:Number(r.horizon_hr || r.h || 0),
        p10:Number(r.p10), p25:Number(r.p25), p50:Number(r.p50), p75:Number(r.p75), p90:Number(r.p90)
      })).filter(r=>r.date && isFinite(r.p50));
      logDbg(`rows(forecast): ${state.forecast.length}`);
    }catch(e){ logDbg("forecast not found (ok)"); }

    initFilters();
    hydrateAll();
    initQuickCalc();
    initBenchmarkUI();
    initROIImproved();       // <<< new
    renderForecast();        // after benchmark init
  }

  // ---------------------- FILTERS + KPI ----------------------
  function setOptions(el, arr, withAll=true){
    if (!el) return;
    const vals = withAll ? ["All", ...arr] : arr;
    el.innerHTML = vals.map(v=>`<option>${v}</option>`).join("");
  }

  function initFilters(){
    const gpus = uniq(state.scores.map(r=>r.gpu)).sort();
    const regs = uniq(state.scores.map(r=>r.region)).sort();
    const types= uniq(state.scores.map(r=>r.type)).sort();
    const durs = uniq(state.scores.map(r=>r.duration)).sort();
    const cnts = uniq(state.scores.map(r=>r.count).filter(Boolean)).sort((a,b)=>a-b);

    const gpuSel=document.getElementById("f_gpu");
    const regSel=document.getElementById("f_region");
    const typSel=document.getElementById("f_type");
    const durSel=document.getElementById("f_duration");
    const cntSel=document.getElementById("f_count");

    setOptions(gpuSel,gpus);
    setOptions(regSel,regs);
    setOptions(typSel,types);
    setOptions(durSel,durs);
    setOptions(cntSel,cnts);

    if (gpuSel) gpuSel.value = gpus.includes("H100") ? "H100" : (gpus[0]||"All");
    if (typSel) typSel.value = types.includes("On-Demand") ? "On-Demand" : "All";
    if (regSel) regSel.value="All";
    if (durSel) durSel.value="All";
    if (cntSel) cntSel.value="All";

    state.filters={gpu:gpuSel?.value||"All", region:"All", type:typSel?.value||"All", duration:"All", count:"All"};

    [gpuSel,regSel,typSel,durSel,cntSel].forEach((el,i)=>{
      if (!el) return;
      const keys=["gpu","region","type","duration","count"]; const k=keys[i];
      el.addEventListener("change", ()=>{ state.filters[k]=el.value; hydrateAll(); });
    });

    const times = [
      ...state.scores.map(r=>r.ts).filter(Boolean),
      ...state.roi.map(r=>r.ts).filter(Boolean)
    ].sort();
    const latest = times.pop();
    const asOfEl = document.getElementById("asOf");
    if (asOfEl) asOfEl.textContent = "Updated: " + (latest ? fmt.date(latest) : new Date().toISOString().replace('T',' ').replace('Z',''));
  }

  function applyFilters(rows){
    const f=state.filters;
    return rows.filter(r=>
      (f.gpu==="All"||r.gpu===f.gpu) &&
      (f.region==="All"||r.region===f.region) &&
      (f.type==="All"||r.type===f.type) &&
      (f.duration==="All"||r.duration===f.duration) &&
      (f.count==="All"|| String(r.count)===String(f.count))
    );
  }

  function hydrateAll(){
    const rows=applyFilters(state.scores).sort(byNumAsc("price"));
    const kpiRows = document.getElementById("kpi_rows"); if (kpiRows) kpiRows.textContent = rows.length;

    if(rows.length){
      const lo=rows[0];
      const set = (id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
      set("kpi_low", fmt.money(lo.price));
      set("kpi_low_sub", `${lo.provider} · ${lo.region} · ${lo.gpu} (${lo.type})`);
      const prices=rows.map(r=>r.price).filter(isFinite).sort((a,b)=>a-b);
      const mid=prices[Math.floor(prices.length/2)];
      set("kpi_med", fmt.money(mid));
      set("kpi_med_sub", `${rows.length} quotes`);
      set("kpi_prov", uniq(rows.map(r=>r.provider)).length);
    }else{
      ["kpi_low","kpi_med","kpi_prov"].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent="–"; });
      ["kpi_low_sub","kpi_med_sub"].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=""; });
    }

    // Leaderboard
    const lbBody = document.querySelector("#tbl_leader tbody");
    if (lbBody){
      lbBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.provider}</td><td>${r.region}</td><td>${r.gpu}</td>
          <td><span class="pill">${r.type}</span></td>
          <td>${r.duration||"–"}</td>
          <td>${r.count!=null? r.count : "–"}</td>
          <td class="right">${fmt.money(r.price)}</td>
          <td class="right">${r.score!=null? Number(r.score).toFixed(1):"–"}</td>
          <td class="right">${fmt.date(r.ts)}</td>
        </tr>`).join("");
    }

    // Snapshot
    const cbody=document.querySelector("#tbl_comp tbody");
    if (cbody){
      cbody.innerHTML = state.snap.map(r=>{
        const lo = r.price_lo ?? r.price_lo_usd ?? r.lo;
        const md = r.price_md ?? r.price_md_usd ?? r.md;
        const hi = r.price_hi ?? r.price_hi_usd ?? r.hi;
        return `<tr>
          <td>${r.gpu_model || r.gpu || ""}</td>
          <td>${r.provider_type || r.provider_type_label || ""}</td>
          <td>${r["$/GPU-hr"] || (lo && hi ? `$${lo}–$${hi}`:"")}</td>
          <td>${r.TOTAL || r.total || ""}</td>
          <td class="right">${lo??""}</td>
          <td class="right">${md??""}</td>
          <td class="right">${hi??""}</td>
          <td class="right">${r.term_hours || r.term_hrs || ""}</td>
          <td class="right">${r.gpu_count || r.gpus || ""}</td>
          <td>${r.used_region || r.region || ""}</td>
          <td class="right">${r.n_quotes || r.quotes || ""}</td>
          <td>${r.source || ""}</td>
        </tr>`;
      }).join("");
    }

    // Pred tiles from snapshot
    const pp = state.predict||{};
    const moneyOrDash = v => (v==null||isNaN(v)) ? "–" : `$${Number(v).toFixed(2)}`;
    const set = (id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
    set("p10",  moneyOrDash(pp.p10));
    set("p25",  moneyOrDash(pp.p25));
    set("p50",  moneyOrDash(pp.p50));
    set("p7590",`${moneyOrDash(pp.p75||pp.p50)} / ${moneyOrDash(pp.p90)}`);
  }

  // ---------------------- QUICK CALC ----------------------
  function initQuickCalc(){
    const gpus = uniq(state.scores.map(r=>r.gpu)).sort();
    const regs = uniq(state.scores.map(r=>r.region)).sort();

    function setOpts(el, arr){ if(el) el.innerHTML = arr.map(v=>`<option>${v}</option>`).join(""); }
    const qc_gpu   = document.getElementById("qc_gpu");
    const qc_region= document.getElementById("qc_region");
    const qc_count = document.getElementById("qc_count");
    const qc_dur   = document.getElementById("qc_dur");

    setOpts(qc_gpu, gpus);
    setOpts(qc_region, regs);
    setOpts(qc_count, [8,16,32,64]);
    setOpts(qc_dur, ["1 hour","1 day","1 week","1 month"]);

    if (qc_gpu)    qc_gpu.value   = gpus.includes("H100") ? "H100" : (gpus[0]||"");
    if (qc_region) qc_region.value= regs.includes("Global") ? "Global" : (regs[0]||"");
    if (qc_count)  qc_count.value = "8";
    if (qc_dur)    qc_dur.value   = "1 hour";

    const btn = document.getElementById("btnCalc");
    if (btn) btn.onclick = runQuickCalc;
    runQuickCalc();
  }

  function runQuickCalc(){
    const qc_gpu   = document.getElementById("qc_gpu");
    const qc_region= document.getElementById("qc_region");
    const qc_count = document.getElementById("qc_count");
    const qc_dur   = document.getElementById("qc_dur");
    if (!qc_gpu || !qc_region || !qc_count || !qc_dur) return;

    const gpu  = qc_gpu.value;
    let   reg  = qc_region.value;
    const cnt  = Number(qc_count.value||0);
    const hrs  = durToHours(qc_dur.value);
    const usePred = !!document.getElementById("qc_usePred")?.checked;

    // Primary: exact region
    let rows = state.scores.filter(r=> r.gpu===gpu && r.region===reg && /On-Demand/i.test(r.type));
    // Fallback to any region
    if (!rows.length){
      const any = state.scores.find(r=> r.gpu===gpu && /On-Demand/i.test(r.type));
      if (any){
        reg = any.region;
        rows = state.scores.filter(r=> r.gpu===gpu && r.region===reg && /On-Demand/i.test(r.type));
        if (qc_region) qc_region.value = reg;
        logDbg(`QC: no rows for chosen region, using ${reg}`);
      }
    }

    const byProv = new Map();
    rows.forEach(r=>{
      const k=r.provider+"|"+r.region;
      const best=byProv.get(k);
      if(!best || r.price<best.price) byProv.set(k,r);
    });

    let out=[...byProv.values()].map(r=>({
      provider:r.provider, region:r.region, price:r.price, total:r.price*cnt*hrs, src:"observed"
    }));

    if(usePred && state.predict && state.predict.gpu_model===gpu && state.predict.region===reg && state.predict.p50){
      out.push({ provider:"Predicted (P50)", region:reg, price:Number(state.predict.p50), total:Number(state.predict.p50)*cnt*hrs, src:"predicted" });
    }

    out.sort((a,b)=>a.total-b.total);
    const body = document.querySelector("#tbl_qc tbody");
    if (body){
      body.innerHTML = out.map(r=>`
        <tr>
          <td>${r.provider}</td><td>${r.region}</td>
          <td class="right">${fmt.money(r.price)}</td>
          <td class="right">${fmt.money0(r.total)}</td>
          <td class="right"><span class="badge">${r.src}</span></td>
        </tr>`).join("");
    }
  }

  // ---------------------- PRICE BENCHMARK (same as before) ----------------------
  function setOptionsPlain(el, arr){ if(el) el.innerHTML = arr.map(v=>`<option>${v}</option>`).join(""); }
  function kde(values, gridN=160){
    const n=values.length; if(!n) return {x:[], y:[]};
    const mean = values.reduce((a,b)=>a+b,0)/n;
    const s2 = values.reduce((a,b)=>a+(b-mean)**2,0)/Math.max(1,n-1);
    const sd = Math.sqrt(Math.max(s2, 1e-9));
    const h = 1.06*sd*Math.pow(n,-1/5);
    const minV = Math.min(...values), maxV = Math.max(...values);
    const pad = 0.15*(maxV-minV || 1);
    const lo = minV - pad, hi = maxV + pad;
    const x = Array.from({length:gridN},(_,i)=> lo + (i/(gridN-1))*(hi-lo));
    const y = x.map(xi=>{
      let s=0; for(const v of values){ const u=(xi-v)/h; s += Math.exp(-0.5*u*u); }
      return s/(n*h*Math.sqrt(2*Math.PI));
    });
    const ymax = Math.max(...y, 1e-9);
    return {x, y: y.map(d=>d/ymax)};
  }

  function initBenchmarkUI(){
    const rows = state.scores;
    const gpus   = [...new Set(rows.map(r=>r.gpu))].sort();
    const regions= [...new Set(rows.map(r=>r.region))].sort();
    const types  = [...new Set(rows.map(r=>r.type))].sort();
    const durs   = [...new Set(rows.map(r=>r.duration))].sort();
    const counts = [...new Set(rows.map(r=>r.count).filter(Boolean))].sort((a,b)=>a-b);

    setOptionsPlain(document.getElementById("bm_gpu"),     gpus.length?gpus:["H100","H200"]);
    setOptionsPlain(document.getElementById("bm_region"),  regions);
    setOptionsPlain(document.getElementById("bm_type"),    types);
    setOptionsPlain(document.getElementById("bm_duration"),durs);
    setOptionsPlain(document.getElementById("bm_count"),   counts);

    const bm_gpu=document.getElementById("bm_gpu");
    const bm_region=document.getElementById("bm_region");
    const bm_type=document.getElementById("bm_type");
    const bm_duration=document.getElementById("bm_duration");
    const bm_count=document.getElementById("bm_count");

    if (bm_gpu)      bm_gpu.value      = gpus.includes("H100")?"H100":(gpus[0]||"");
    if (bm_region)   bm_region.value   = regions.includes("Global")?"Global":(regions[0]||"");
    if (bm_type)     bm_type.value     = types.find(t=>/On-Demand/i.test(t)) || (types[0]||"");
    if (bm_duration) bm_duration.value = durs.find(d=>/1h|1 hour/i.test(d)) || (durs[0]||"");
    if (bm_count)    bm_count.value    = counts.includes(8)?8:(counts[0]||"");

    const run = ()=>{ runBenchmark(); renderForecast(); };
    const bm_run=document.getElementById("bm_run");
    if (bm_run) bm_run.onclick = run;
    ["bm_gpu","bm_region","bm_type","bm_duration","bm_count"].forEach(id=>{
      const el=document.getElementById(id);
      if (el) el.addEventListener("change", run);
    });
    runBenchmark();
  }

  function runBenchmark(){
    const bm_gpu=document.getElementById("bm_gpu");
    const bm_region=document.getElementById("bm_region");
    const bm_type=document.getElementById("bm_type");
    const bm_duration=document.getElementById("bm_duration");
    const bm_count=document.getElementById("bm_count");
    if (!bm_gpu || !bm_region || !bm_type || !bm_duration || !bm_count) return;

    const gpu  = bm_gpu.value;
    const reg0 = bm_region.value;
    const typ0 = bm_type.value;
    const dur0 = bm_duration.value;
    const cnt0 = bm_count.value;

    let sample = state.scores.filter(r=> r.gpu===gpu && r.region===reg0 && r.type===typ0 && r.duration===dur0 && String(r.count)===String(cnt0));
    let note = `exact slice (${sample.length})`;
    if (sample.length < 8) { sample = state.scores.filter(r=> r.gpu===gpu && r.region===reg0 && r.type===typ0 && r.duration===dur0); note="relaxed: drop count"; }
    if (sample.length < 8) { sample = state.scores.filter(r=> r.gpu===gpu && r.region===reg0 && r.type===typ0); note="relaxed: drop duration + count"; }
    if (sample.length < 8) { sample = state.scores.filter(r=> r.gpu===gpu && r.type===typ0); note="relaxed: drop region + duration + count"; }
    if (sample.length < 8) { sample = state.scores.filter(r=> r.gpu===gpu); note="relaxed: GPU only"; }

    const vals = sample.map(r=>r.price).filter(Number.isFinite).sort((a,b)=>a-b);
    const q = (sorted, ps)=>{
      const n = sorted.length; if (!n) return ps.map(()=>NaN);
      return ps.map(p => {
        if (n===1) return sorted[0];
        const idx = (n-1)*p, lo=Math.floor(idx), hi=Math.ceil(idx);
        if (lo===hi) return sorted[lo];
        const w = idx-lo; return sorted[lo]*(1-w) + sorted[hi]*w;
      });
    };
    const [p10,p25,p50,p75,p90] = q(vals,[0.10,0.25,0.50,0.75,0.90]);

    const money = n => isFinite(n) ? `$${n.toFixed(2)}` : "–";
    const set = (id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
    set("bm_p10", money(p10));
    set("bm_p25", money(p25));
    set("bm_p50", money(p50));
    set("bm_p75", money(p75));
    set("bm_p90", money(p90));
    set("bm_big", money(p50));

    let noteTxt = `Samples: ${vals.length} (${note})`;
    let conf = "Low";
    if (isFinite(p50) && isFinite(p25) && isFinite(p75) && vals.length){
      const iqr = Math.max(0, p75 - p25);
      const disp = iqr / Math.max(p50, 1e-9);
      conf = (vals.length>=40 && disp<0.25) ? "High" :
             (vals.length>=20 && disp<0.40) ? "Medium" : "Low";
      noteTxt += ` · Confidence: ${conf}`;
    }
    set("bm_note", noteTxt);

    const dealEl = document.getElementById("bm_deal");
    if (dealEl){
      dealEl.style.display = "none";
      dealEl.className = "badge";
      if (vals.length && isFinite(p25) && isFinite(p75)){
        const cheapest = vals[0];
        if (cheapest < p25){ dealEl.textContent = "Deal (book now)"; dealEl.classList.add("best"); dealEl.style.display = "inline-block"; }
        else if (cheapest > p75){ dealEl.textContent = "Rich (likely cheaper later)"; dealEl.classList.add("warn"); dealEl.style.display = "inline-block"; }
        else { dealEl.textContent = "Fair"; dealEl.style.display = "inline-block"; }
      }
    }

    const {x, y} = kde(vals);
    const canvas = document.getElementById("bm_chart");
    if (canvas && window.Chart){
      const ctx = canvas.getContext("2d");
      if (window._bmChart) window._bmChart.destroy();
      window._bmChart = new Chart(ctx,{
        type:'line',
        data:{ labels: x, datasets:[{label:'Normalized Price Distribution', data:y, fill:true, tension:0.35, pointRadius:0, borderWidth:2}]},
        options:{
          responsive:true,
          plugins:{ legend:{display:true}},
          scales:{
            y:{ min:0, max:1, ticks:{ callback:v=>v.toFixed(1)}},
            x:{ ticks:{ callback:(v)=>'$'+Number(x[v]).toFixed(2), autoSkip:true, maxRotation:0 } }
          },
          interaction:{ mode:'index', intersect:false }
        }
      });
    }
  }

  // ---------------------- FORECAST ----------------------
  let _fcChart;
  function renderForecast(){
    const fc = state.forecast||[];
    const noteEl = document.getElementById("fcNote");
    const metaEl = document.getElementById("fcMeta");
    if (!fc.length){
      if (noteEl) noteEl.textContent = "No forecast.csv found or no rows. Add it via the training step.";
      if (_fcChart){ _fcChart.destroy(); _fcChart=null; }
      return;
    }

    const gpuSel = document.getElementById("bm_gpu")?.value;
    const regSel = document.getElementById("bm_region")?.value;
    const typSel = document.getElementById("bm_type")?.value;
    const durSel = document.getElementById("bm_duration")?.value;
    const cntSel = Number(document.getElementById("bm_count")?.value);

    let rows = fc.filter(r=> r.gpu===gpuSel && r.region===regSel && r.type===typSel && r.duration===durSel && r.count===cntSel);
    let used = {gpu:gpuSel, region:regSel, type:typSel, duration:durSel, count:cntSel, matched:true};
    if (!rows.length){
      rows = fc.slice();
      used = {gpu:fc[0].gpu, region:fc[0].region, type:fc[0].type, duration:fc[0].duration, count:fc[0].count, matched:false};
    }
    rows.sort((a,b)=> new Date(a.date) - new Date(b.date));

    const labels = rows.map(r=>{
      const d = new Date(r.date);
      const mm = d.toLocaleString(undefined,{month:'short'});
      const dd = d.getDate();
      const hh = String(d.getHours()).padStart(2,'0');
      return `${mm} ${dd} ${hh}:00`;
    });
    const p10 = rows.map(r=>r.p10);
    const p50 = rows.map(r=>r.p50);
    const p90 = rows.map(r=>r.p90);

    const canvas = document.getElementById("fc_chart");
    if (!canvas || !window.Chart) return;
    const ctx = canvas.getContext("2d");
    if (_fcChart) _fcChart.destroy();

    _fcChart = new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'P10', data:p10, pointRadius:0, borderWidth:1, tension:0.25, fill:false, hidden:true},
          {label:'P10–P90 band', data:p90, pointRadius:0, borderWidth:0, tension:0.25, fill:{target:0}},
          {label:'P50', data:p50, pointRadius:0, borderWidth:2, tension:0.25}
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true}},
        scales:{
          y:{ ticks:{ callback:v=>"$"+Number(v).toFixed(2)}},
          x:{ ticks:{ autoSkip:true, maxRotation:0 }}
        },
        interaction:{ mode:'index', intersect:false }
      }
    });

    if (metaEl) metaEl.textContent = `${used.gpu} · ${used.region} · ${used.type} · ${used.duration} · ${used.count} GPUs` + (used.matched?"":" (showing available slice)");
    if (noteEl) noteEl.textContent = `Points: ${rows.length}. Band shows P10–P90; line shows P50.`;
  }

  // ---------------------- ROI (IMPROVED GRID) ----------------------
  const DUR_ORDER = ["1 hour","1 day","1 week","1 month"];
  const COUNT_ORDER = [8,16,32,64];

  function fmtMoney0(n){ return isFinite(n) ? `$${Number(n).toFixed(0)}` : "–"; }
  function fmtRate2(n){  return isFinite(n) ? `$${Number(n).toFixed(2)}` : "–"; }

  function buildBestByScenario(rows, metric){
    // metric: "total" | "rate"
    const key = r => [r.gpu, r.region, r.count, r.duration].join("|");
    const best = new Map();
    for (const r of rows){
      if (!isFinite(r.total) || !isFinite(r.p_eff) || !isFinite(r.count) || !isFinite(r.hrs)) continue;
      const k = key(r);
      const cur = best.get(k);
      const lhs = (metric==="rate") ? r.p_eff : r.total;
      if (!cur) best.set(k, r);
      else {
        const rhs = (metric==="rate") ? cur.p_eff : cur.total;
        if (lhs < rhs) best.set(k, r);
      }
    }
    return [...best.values()];
  }

  function initROIImproved(){
    if (!state.roi?.length) return;

    const gpuSel = document.getElementById("roi_gpu");
    const regSel = document.getElementById("roi_region");
    const metSel = document.getElementById("roi_metric");
    const reset  = document.getElementById("roi_reset");
    const gridEl = document.getElementById("roi_grid");
    const detBox = document.getElementById("roi_details");
    const detTitle = document.getElementById("roi_detail_title");
    const detMeta  = document.getElementById("roi_detail_meta");
    const detBody  = document.getElementById("roi_detail_body");

    const gpus = uniq(state.roi.map(r=>r.gpu)).sort();
    const regs = uniq(state.roi.map(r=>r.region)).sort();
    if (gpuSel) gpuSel.innerHTML = gpus.map(g=>`<option>${g}</option>`).join("");
    if (regSel) regSel.innerHTML = ["All", ...regs].map(r=>`<option>${r}</option>`).join("");
    if (gpuSel) gpuSel.value = gpus.includes("H100") ? "H100" : gpus[0];
    if (regSel) regSel.value = "All";

    function render(){
      if (!gridEl) return;
      const gpu = gpuSel?.value || gpus[0];
      const region = regSel?.value || "All";
      const metric = metSel?.value || "total";

      let rows = state.roi.filter(r => r.gpu===gpu);
      if (region !== "All") rows = rows.filter(r => r.region===region);

      const best = buildBestByScenario(rows, metric);

      const durations = DUR_ORDER.filter(d => best.some(r=>r.duration===d));
      const counts = COUNT_ORDER.filter(c => best.some(r=>r.count===c));

      if (!durations.length || !counts.length){
        gridEl.style.display = "block";
        gridEl.innerHTML = `<div class="small" style="color:var(--sub)">No ROI scenarios match the current filters.</div>`;
        if (detBox) detBox.style.display = "none";
        return;
      }

      // grid: first column labels + one column per count
      gridEl.style.display = "grid";
      gridEl.style.gridTemplateColumns = `160px ${counts.map(()=> "1fr").join(" ")}`;
      // header row
      let html = `<div></div>${counts.map(c=>`<div class="small" style="color:var(--sub);font-weight:600">Count: ${c}</div>`).join("")}`;
      // rows
      for (const d of durations){
        html += `<div class="small" style="color:var(--sub);font-weight:600">${d}</div>`;
        for (const c of counts){
          const cell = best.find(r=> r.duration===d && r.count===c);
          if (!cell){
            html += `<div class="roiCell" style="opacity:0.5"><div class="sub">–</div></div>`;
            continue;
          }
          const totalTxt = fmtMoney0(cell.total);
          const rateTxt  = fmtRate2(cell.p_eff);
          html += `<div class="roiCell" data-gpu="${cell.gpu}" data-region="${cell.region}" data-count="${c}" data-duration="${d}">
            <h4>${cell.provider} <span class="small" style="color:var(--sub)">· ${cell.region}</span></h4>
            <div class="total">${totalTxt}</div>
            <div class="small" style="color:var(--sub)">${rateTxt} / GPU-hr</div>
          </div>`;
        }
      }
      gridEl.innerHTML = html;

      // cell clicks -> show top-3
      gridEl.querySelectorAll('.roiCell').forEach(div=>{
        div.addEventListener('click', ()=>{
          const d = div.getAttribute('data-duration');
          const c = Number(div.getAttribute('data-count'));
          const reg = div.getAttribute('data-region');
          const slice = rows.filter(r=> r.duration===d && r.count===c && r.region===reg);
          // sort by metric
          slice.sort((a,b)=> (metric==="rate" ? a.p_eff - b.p_eff : a.total - b.total));
          const top = slice.slice(0,3);
          if (detTitle) detTitle.textContent = `Top options — ${gpu}, ${c} GPUs, ${d}`;
          if (detMeta) detMeta.textContent = `${reg} · Metric: ${metric==="rate" ? "$/GPU-hr (derived)" : "Total cost"}`;
          if (detBody) detBody.innerHTML = top.map(r=>{
            const w = Math.max(6, Math.round( (r.total / Math.max(top[0].total,1e-9)) * 100 ));
            return `<tr>
              <td>${r.provider}</td>
              <td>${r.region}</td>
              <td class="right">${fmtRate2(r.p_eff)}</td>
              <td class="right">
                ${fmtMoney0(r.total)}
                <div class="barWrap"><div class="bar" style="width:${w}%"></div></div>
              </td>
            </tr>`;
          }).join("");
          if (detBox) detBox.style.display = "block";
        });
      });
    }

    [gpuSel, regSel, metSel].forEach(el => el && el.addEventListener('change', render));
    reset && reset.addEventListener('click', ()=>{
      if (gpuSel) gpuSel.value = gpus.includes("H100") ? "H100" : gpus[0];
      if (regSel) regSel.value = "All";
      if (metSel) metSel.value = "total";
      render();
    });

    render();
  }

  // ---------------------- BOOT ----------------------
  loadAll();
})();
});
</script>
</body>
</html>




