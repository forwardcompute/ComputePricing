<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Price-IQ</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --bg:#0f1216; --panel:#171b21; --muted:#202532; --text:#e7edf3; --sub:#9fb0c3;
    --accent:#7bd7ff; --ok:#27d980; --warn:#ffd166; --danger:#ff6b6b;
    --chip:#222838; --chipStroke:#2b3143; --chipText:#cfd9e5;
    --row:#12161c; --rowAlt:#141922; --badge:#283042;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  header h1{font-size:26px;margin:0}
  .updated{margin-left:auto;font-size:12px;color:var(--sub);background:var(--panel);border:1px solid var(--chipStroke);padding:6px 10px;border-radius:10px}
  .row{display:grid;gap:12px}
  .hero{grid-template-columns:1fr 1fr 1fr 1fr 1fr 110px}
  .tileRow{grid-template-columns:1fr 1fr 1fr 1fr}
  @media (max-width:980px){ .hero{grid-template-columns:1fr 1fr} .tileRow{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
  .select, .btn, .inp{width:100%;appearance:none;background:var(--chip);border:1px solid var(--chipStroke);color:var(--text);padding:10px 12px;border-radius:10px}
  .select{padding-right:36px;background-image:linear-gradient(45deg,transparent 50%,var(--sub) 50%),linear-gradient(135deg,var(--sub) 50%,transparent 50%),linear-gradient(to right,transparent,transparent);
          background-position:calc(100% - 18px) 16px,calc(100% - 12px) 16px,100% 0;background-size:6px 6px,6px 6px,2.5em 2.5em;background-repeat:no-repeat}
  .btn{cursor:pointer}
  .btn.clear{background:#1d2430;border-color:#2a3244}
  .stat{display:flex;flex-direction:column;gap:6px}
  .stat h4{margin:0;color:var(--sub);font-weight:600}
  .stat .val{font-size:28px;font-weight:700}
  .stat .sub{color:var(--sub);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);color:var(--sub);font-size:12px;border:1px solid var(--chipStroke)}
  .badge.best{background:rgba(39,217,128,0.12); color:#9ff3c8; border-color:rgba(39,217,128,0.25)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{color:var(--sub);font-weight:600;text-align:left;font-size:12px;padding:0 10px 6px}
  tbody tr{background:var(--row);border:1px solid var(--muted)}
  tbody tr:nth-child(even){background:var(--rowAlt)}
  td{padding:12px 10px;vertical-align:middle}
  td .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chipStroke);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--chipText)}
  .right{justify-self:end;text-align:right}
  .sectionTitle{display:flex;align-items:center;gap:10px;margin:18px 4px 8px}
  .small{font-size:12px;color:var(--sub)}
  .debug{display:none}
  .debug.on{display:block}
  .controls{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .control{display:flex;flex-direction:column;gap:6px}
  .control label{font-size:11px;color:var(--sub);padding-left:2px}
  .barWrap{margin-top:6px;height:6px;background:rgba(255,255,255,0.05);border:1px solid var(--chipStroke);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg, var(--accent), #89e1ff)}
  .roiCell{background:var(--row);border:1px solid var(--muted);border-radius:12px;padding:10px;cursor:pointer}
  .roiCell h4{margin:0 0 6px 0;font-size:13px;color:var(--sub);font-weight:600}
  .roiCell .total{font-size:18px;font-weight:800}

  /* error banner */
  #errBanner{display:none;margin:10px 0;padding:10px;border-radius:10px;border:1px solid #4b1f24;background:#2a0f12;color:#ffb3b8}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Price-IQ</h1>
      <span class="small">Auto-generated from <code>data/derived/</code></span>
      <div class="updated" id="asOf">Updated: —</div>
    </header>

    <div id="errBanner"></div>

    <!-- HERO FILTERS -->
    <div class="row hero">
      <div class="control"><label>GPU</label><select id="f_gpu" class="select"></select></div>
      <div class="control"><label>Region</label><select id="f_region" class="select"></select></div>
      <div class="control"><label>Type</label><select id="f_type" class="select"></select></div>
      <div class="control"><label>Duration</label><select id="f_duration" class="select"></select></div>
      <div class="control"><label>GPU Count</label><select id="f_count" class="select"></select></div>
      <div class="control"><label>&nbsp;</label><button class="btn clear" id="btnClear">Clear</button></div>
    </div>

    <!-- KPI TILES -->
    <div class="row tileRow" style="margin-top:12px">
      <div class="card stat">
        <h4>Cheapest / GPU-hr</h4>
        <div class="val" id="kpi_low">–</div>
        <div class="sub" id="kpi_low_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Median / GPU-hr</h4>
        <div class="val" id="kpi_med">–</div>
        <div class="sub" id="kpi_med_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Providers covered</h4>
        <div class="val" id="kpi_prov">–</div>
        <div class="sub" id="kpi_prov_sub">Unique provider names in current filter.</div>
      </div>
      <div class="card stat">
        <h4>Entries</h4>
        <div class="val" id="kpi_rows">0</div>
        <div class="sub">Rows displayed in leaderboard.</div>
      </div>
    </div>

    <!-- DATA STATUS -->
    <div class="sectionTitle" style="margin-top:18px">
      <div class="switch small"><input type="checkbox" id="toggleDebug"><label for="toggleDebug">Show data status (debug)</label></div>
    </div>
    <div class="card debug" id="debugPanel"><div id="debugLines" class="small"></div></div>

    <!-- LEADERBOARD -->
    <div class="sectionTitle">
      <h3 style="margin:0">Leaderboard (Price-IQ)</h3>
      <span class="small" id="lbSort">Sorted by price ↑</span>
    </div>
    <div class="card">
      <table id="tbl_leader">
        <thead>
          <tr>
            <th>Provider</th><th>Region</th><th>GPU</th><th>Type</th>
            <th>Duration</th><th>Count</th>
            <th class="right">$/GPU-hr</th><th class="right">Score</th><th class="right">Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ROI (IMPROVED GRID) -->
    <div class="sectionTitle">
      <h3 style="margin:0">ROI (Cheapest total cost)</h3>
      <span class="small">from <code>roi_comparison.csv</code></span>
    </div>
    <div class="card" id="roiCard">
      <div class="controls" style="flex-wrap:wrap;gap:8px;margin-bottom:12px">
        <div class="control"><label>GPU</label><select id="roi_gpu" class="select" style="min-width:140px"></select></div>
        <div class="control"><label>Region</label><select id="roi_region" class="select" style="min-width:140px"></select></div>
        <div class="control"><label>Metric</label>
          <select id="roi_metric" class="select" style="min-width:160px">
            <option value="total">Total cost</option>
            <option value="rate">$/GPU-hr (derived)</option>
          </select>
        </div>
        <div class="control"><label>&nbsp;</label><button id="roi_reset" class="btn clear">Reset</button></div>
      </div>

      <div class="small" style="color:var(--sub)">Click a scenario to see Top-3</div>
      <div id="roi_grid" class="row" style="gap:10px"></div>

      <div id="roi_details" class="card" style="margin-top:12px; display:none">
        <div class="sectionTitle" style="margin-top:0">
          <h3 style="margin:0" id="roi_detail_title">Top options</h3>
          <span class="small" id="roi_detail_meta"></span>
        </div>
        <table style="width:100%">
          <thead>
            <tr>
              <th>Provider</th><th>Region</th>
              <th class="right">$/GPU-hr</th>
              <th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="roi_detail_body"></tbody>
        </table>
      </div>
    </div>

    <!-- PRICE BENCHMARK -->
    <div class="sectionTitle">
      <h3 style="margin:0">Price benchmark (cross-provider)</h3>
      <span class="small">from <code>data/derived/provider_scores_latest.csv</code></span>
    </div>
    <div class="card" id="benchCard">
      <div class="row" style="grid-template-columns:320px 1fr; gap:18px">
        <div>
          <div class="control" style="margin-bottom:10px"><label>GPU</label>
            <select id="bm_gpu" class="select"><option>H100</option><option>H200</option></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Region</label>
            <select id="bm_region" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Type</label>
            <select id="bm_type" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>Duration</label>
            <select id="bm_duration" class="select"></select>
          </div>
          <div class="control" style="margin-bottom:10px"><label>GPU Count</label>
            <select id="bm_count" class="select"></select>
          </div>
          <button class="btn" id="bm_run">Predict price</button>
          <div class="small" id="bm_note" style="margin-top:8px;color:var(--sub)"></div>
          <div class="small" style="margin-top:8px;color:var(--sub)">Deal guidance: <span id="bm_deal" class="badge" style="display:none"></span></div>
        </div>

        <div>
          <div class="row tileRow">
            <div class="card stat"><h4>10% quantile</h4><div class="val" id="bm_p10">–</div></div>
            <div class="card stat"><h4>25% quantile</h4><div class="val" id="bm_p25">–</div></div>
            <div class="card stat"><h4>Median</h4><div class="val" id="bm_p50">–</div></div>
            <div class="card stat"><h4>75% quantile</h4><div class="val" id="bm_p75">–</div></div>
            <div class="card stat"><h4>90% quantile</h4><div class="val" id="bm_p90">–</div></div>
          </div>

          <div class="card" style="margin-top:12px;text-align:center">
            <div class="small" style="margin-bottom:6px;color:var(--sub)">Predicted price (P50)</div>
            <div style="font-size:40px;font-weight:800" id="bm_big">–</div>
          </div>

          <div class="card" style="margin-top:12px">
            <canvas id="bm_chart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- FORECAST -->
    <div class="sectionTitle">
      <h3 style="margin:0">Forecast (next 72 hours)</h3>
      <span class="small">from <code>forecast.csv</code> · <span id="fcMeta"></span></span>
    </div>
    <div class="card" id="fcCard">
      <div id="fcEmpty" class="small" style="margin-bottom:8px;color:var(--sub);display:none">
        No <code>forecast.csv</code> found or no rows.
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <input id="fcUpload" type="file" accept=".csv" class="select" style="max-width:260px" />
          <button id="fcGen" class="btn">Generate simple 72h</button>
          <button id="fcTpl" class="btn clear">CSV template</button>
          <button id="fcTrainer" class="btn">Download ML trainer (LightGBM)</button>
        </div>
      </div>
      <div class="small" id="fcNote" style="margin-bottom:8px;color:var(--sub)"></div>
      <canvas id="fc_chart" height="120" style="display:none"></canvas>
    </div>

    <!-- SNAPSHOT -->
    <div class="sectionTitle">
      <h3 style="margin:0">Compute Calculator Snapshot</h3>
      <span class="small">from <code>compute_calculator_snapshot.csv</code></span>
    </div>
    <div class="card">
      <table id="tbl_comp">
        <thead>
          <tr>
            <th>GPU</th><th>Provider type</th><th>$ / GPU-hr</th><th>TOTAL (term)</th>
            <th class="right">lo</th><th class="right">md</th><th class="right">hi</th>
            <th class="right">term hrs</th><th class="right">GPUs</th><th>Region</th><th class="right">#quotes</th><th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="small" style="margin:16px 4px 40px">
      Tip: serve over HTTP (e.g. <code>python -m http.server</code>). Data loads from <code>data/derived/</code>.
      Toggle debug to see which files were found.
    </p>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
(function(){
  // ---------------------- DEBUG ----------------------
  const dbg=[]; 
  const logDbg=(m)=>{dbg.push(m); const el=document.getElementById("debugLines"); if(el) el.innerHTML=dbg.map(s=>`<div>${s}</div>`).join(""); console.log("[Price-IQ]",m);};
  const dbgToggle=document.getElementById("toggleDebug"), debugPanel=document.getElementById("debugPanel");
  if (dbgToggle && debugPanel) dbgToggle.addEventListener("change",(e)=>debugPanel.classList.toggle("on", e.target.checked));
  const errBanner=document.getElementById('errBanner');
  const showErr=(msg)=>{ if(!errBanner) return; errBanner.style.display='block'; errBanner.textContent=msg; };

  // ---------------------- UTILS ----------------------
  const fmt={ money:n=>n==null||isNaN(n)?'–':`$${Number(n).toFixed(2)}`, money0:n=>n==null||isNaN(n)?'–':`$${Number(n).toFixed(0)}`, num:n=>n==null||isNaN(n)?'–':Number(n).toLocaleString(), date:s=>s?String(s).replace('T',' ').replace('Z',''):'–' };
  const numify=x=> x==null ? NaN : Number(String(x).replace(/[^\d.\-]/g,""));
  // RFC4180-ish CSV parser (handles quotes, commas, BOM)
  function parseCSV(text){
    if(!text || !text.trim()) return [];
    text = text.replace(/^\uFEFF/,''); // strip BOM
    const rows=[]; let row=[]; let field=''; let inQ=false; let i=0;
    const pushField=()=>{ row.push(field); field=''; };
    const pushRow=()=>{ rows.push(row); row=[]; };
    while(i<text.length){
      const ch=text[i];
      if(inQ){
        if(ch === '"'){
          if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQ = false; i++; continue;
        }
        field += ch; i++; continue;
      }else{
        if(ch === '"'){ inQ=true; i++; continue; }
        if(ch === ','){ pushField(); i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ pushField(); pushRow(); i++; continue; }
        field += ch; i++; continue;
      }
    }
    // last field/row
    pushField(); if(row.length>1 || row[0] !== '') pushRow();
    if(!rows.length) return [];
    const header=rows.shift().map(h=>String(h).trim());
    return rows.filter(r=>r.length && r.some(x=>String(x).trim()!=='')).map(cells=>{
      const o={}; header.forEach((h,idx)=> o[h]= (cells[idx]??'').toString().trim() ); return o;
    });
  }
  const uniq=arr=>[...new Set(arr)];
  const byNumAsc=key=>(a,b)=>(+a[key]||1e12)-(+b[key]||1e12);
  function durToHours(s){ const v=String(s||"").toLowerCase(); if(/month/.test(v)) return 24*30; if(/week/.test(v)) return 24*7; if(/day/.test(v)) return 24; return 1; }
  // helper to map flexible column names
  const pick=(row, keys, fallback=null)=>{ for(const k of keys){ if(row[k]!==undefined && row[k]!== '') return row[k]; } return fallback; };

  // ---------------------- PATHS ----------------------
  async function tryFetch(url){ const bust=(url.includes('?')?'&':'?')+'v='+Date.now(); const r=await fetch(url+bust,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+url); return r; }
  // Try most likely paths first for GitHub Pages (page in /docs/)
  const DER_BASES=[
    "./data/derived/","data/derived/","../data/derived/",
    "docs/data/derived/","./docs/data/derived/",
    "/data/derived/","/docs/data/derived/",
  ];
  async function getDerived(file){
    let lastErr=null;
    for(const b of DER_BASES){
      try{ const r=await tryFetch(b+file); logDbg("✅ "+b+file); return r; }catch(e){ lastErr=e; }
    }
    logDbg("❌ MISSING: "+file);
    if(lastErr) showErr(`Missing or unreachable: ${file}. Put it in docs/data/derived/ (or enable debug to see tried paths).`);
    throw new Error("Missing "+file);
  }

  // ---------------------- STATE ----------------------
  const state={ scores:[], roi:[], predict:null, snap:[], forecast:[], filters:{gpu:"All",region:"All",type:"On-Demand",duration:"All",count:"All"} };

  // ---------------------- LOAD ----------------------
  const files={ scores:"provider_scores_latest.csv", roi:"roi_comparison.csv", predict:"price_predict_snapshot.json", snap:"compute_calculator_snapshot.csv", forecast:"forecast.csv" };

  async function loadAll(){
    let anyLoaded=false;

    try{
      const txt=await (await getDerived(files.scores)).text();
      const rows=parseCSV(txt);
      state.scores=rows.map(r=>{
        const provider=pick(r,["provider","provider_name","name"]);
        const region=pick(r,["region","used_region","location"]);
        const gpu=pick(r,["gpu_model","gpu","model"]);
        const type=pick(r,["type","provider_type","provider_type_label"]);
        const duration=pick(r,["duration","term","term_label"]);
        const count=Number(pick(r,["gpu_count","count","gpus"]));
        const priceRaw=pick(r,[
          "effective_price_usd_per_gpu_hr","price_usd_per_gpu_hr","price_per_gpu_hr","price_hourly_usd","usd_per_gpu_hr","$/GPU-hr"
        ]);
        const score=Number(pick(r,["priceiq_score","price_iq","score"]));
        const ts=pick(r,["timestamp","ts","time_iso","date"]);
        const price=numify(priceRaw);
        return {provider,region,gpu,type,duration,count:isFinite(count)?count:null,price,score:isFinite(score)?score:null,ts};
      }).filter(r=>r.provider && r.gpu && isFinite(r.price));
      logDbg(`rows(scores): ${state.scores.length}`);
      anyLoaded = anyLoaded || state.scores.length>0;
    }catch(e){ logDbg("scores load error: "+e); }

    try{
      const txt=await (await getDerived(files.roi)).text();
      const rows=parseCSV(txt);
      state.roi=rows.map(r=>{
        const gpu=pick(r,["gpu_model","gpu"]);
        const count=Number(pick(r,["gpu_count","count"],""));
        const duration=pick(r,["duration","term"]);
        const provider=pick(r,["best_provider","provider"]);
        const region=pick(r,["best_region","region"]);
        const total=Number(pick(r,["total_cost_usd","total","TOTAL"]));
        const csvRate=Number(pick(r,["price_per_gpu_hr","price_usd_per_gpu_hr","$/GPU-hr"]));
        const hrs=durToHours(duration);
        const derived=(isFinite(total)&&isFinite(count)&&count>0&&hrs>0)?(total/(count*hrs)):NaN;
        let p_eff=isFinite(derived)?derived:csvRate;
        if(isFinite(csvRate)&&isFinite(derived)){
          const diff=Math.abs(csvRate-derived)/Math.max(derived,1e-9);
          p_eff=(diff<=0.01)?csvRate:derived;
        }
        const ts=pick(r,["timestamp","ts","date"]);
        return { gpu, count, duration, provider, region, p_csv:csvRate, p_eff, total, hrs, ts };
      }).filter(r=>isFinite(r.total));
      logDbg(`rows(roi): ${state.roi.length}`);
      anyLoaded = anyLoaded || state.roi.length>0;
    }catch(e){ logDbg("roi load error: "+e); }

    try{ state.predict=await (await getDerived(files.predict)).json(); logDbg("predict: ok"); anyLoaded=true; }catch(e){ logDbg("predict not found (ok)"); }

    try{
      const txt=await (await getDerived(files.snap)).text();
      state.snap=parseCSV(txt);
      logDbg(`rows(snapshot): ${state.snap.length}`);
      anyLoaded = anyLoaded || state.snap.length>0;
    }catch(e){ logDbg("snapshot load error: "+e); }

    try{
      const txt=await (await getDerived(files.forecast)).text();
      const rows=parseCSV(txt);
      state.forecast=rows.map(r=>({
        gpu:pick(r,["gpu_model","gpu"]), region:pick(r,["region"]), type:pick(r,["type"]), duration:pick(r,["duration"]),
        count:Number(pick(r,["gpu_count","count"],0)), date:pick(r,["date_utc","date","ts"]),
        h:Number(pick(r,["horizon_hr","h"],0)), p10:Number(r.p10), p25:Number(r.p25), p50:Number(r.p50), p75:Number(r.p75), p90:Number(r.p90)
      })).filter(r=>r.date && isFinite(r.p50));
      logDbg(`rows(forecast): ${state.forecast.length}`);
      anyLoaded = anyLoaded || state.forecast.length>0;
    }catch(e){ logDbg("forecast not found (ok)"); }

    if(!anyLoaded){
      showErr("No data rows loaded. Turn on 'Show data status (debug)' to see which files/paths failed. Ensure CSV headers match the expected fields or use the flexible variants included here.");
      // auto-open debug to help
      if(dbgToggle && debugPanel){ dbgToggle.checked=true; debugPanel.classList.add('on'); }
    }

    initFilters(); hydrateAll(); initQuickCalc(); initBenchmarkUI(); initROIImproved();
    renderForecast(); // will auto-fill if empty
  }

  // ---------------------- FILTERS + KPI ----------------------
  function setOptions(el,arr,withAll=true){ if(!el) return; const vals=withAll?["All",...arr]:arr; el.innerHTML=vals.map(v=>`<option>${v}</option>`).join(""); }

  function initFilters(){
    const gpus=uniq(state.scores.map(r=>r.gpu).filter(Boolean)).sort(),
          regs=uniq(state.scores.map(r=>r.region).filter(Boolean)).sort(),
          types=uniq(state.scores.map(r=>r.type).filter(Boolean)).sort(),
          durs=uniq(state.scores.map(r=>r.duration).filter(Boolean)).sort(),
          cnts=uniq(state.scores.map(r=>r.count).filter(Boolean)).sort((a,b)=>a-b);
    const gpuSel=document.getElementById("f_gpu"), regSel=document.getElementById("f_region"),
          typSel=document.getElementById("f_type"), durSel=document.getElementById("f_duration"),
          cntSel=document.getElementById("f_count");
    setOptions(gpuSel,gpus); setOptions(regSel,regs); setOptions(typSel,types); setOptions(durSel,durs); setOptions(cntSel,cnts);
    if(gpuSel) gpuSel.value=gpus.includes("H100")?"H100":(gpus[0]||"All");
    if(typSel) typSel.value=types.includes("On-Demand")?"On-Demand":"All";
    if(regSel) regSel.value="All"; if(durSel) durSel.value="All"; if(cntSel) cntSel.value="All";
    state.filters={gpu:gpuSel?.value||"All", region:"All", type:typSel?.value||"All", duration:"All", count:"All"};
    [gpuSel,regSel,typSel,durSel,cntSel].forEach((el,i)=>{ if(!el) return; const keys=["gpu","region","type","duration","count"]; const k=keys[i]; el.addEventListener("change", ()=>{ state.filters[k]=el.value; hydrateAll(); }); });
    const times=[...state.scores.map(r=>r.ts).filter(Boolean), ...state.roi.map(r=>r.ts).filter(Boolean)].sort(); const latest=times.pop();
    const asOf=document.getElementById("asOf"); if(asOf) asOf.textContent="Updated: "+(latest?fmt.date(latest):new Date().toISOString().replace('T',' ').replace('Z',''));
    const btnClear=document.getElementById("btnClear");
    if(btnClear) btnClear.onclick=()=>{ if(gpuSel) gpuSel.value=gpus.includes("H100")?"H100":(gpus[0]||"All"); ["f_region","f_type","f_duration","f_count"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value="All"; }); state.filters={gpu:gpuSel?.value||"All",region:"All",type:"All",duration:"All",count:"All"}; hydrateAll(); };
  }

  function applyFilters(rows){ const f=state.filters; return rows.filter(r=>(f.gpu==="All"||r.gpu===f.gpu)&&(f.region==="All"||r.region===f.region)&&(f.type==="All"||r.type===f.type)&&(f.duration==="All"||r.duration===f.duration)&&(f.count==="All"||String(r.count)===String(f.count))); }

  function hydrateAll(){
    const rows=applyFilters(state.scores).sort(byNumAsc("price"));
    const set=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
    set("kpi_rows", rows.length);
    if(rows.length){
      const lo=rows[0]; set("kpi_low", fmt.money(lo.price)); set("kpi_low_sub", `${lo.provider} · ${lo.region} · ${lo.gpu} (${lo.type})`);
      const prices=rows.map(r=>r.price).filter(isFinite).sort((a,b)=>a-b); const mid=prices[Math.floor(prices.length/2)];
      set("kpi_med", fmt.money(mid)); set("kpi_med_sub", `${rows.length} quotes`); set("kpi_prov", uniq(rows.map(r=>r.provider)).length);
    }else{ ["kpi_low","kpi_med","kpi_prov"].forEach(id=>set(id,"–")); set("kpi_low_sub",""); set("kpi_med_sub",""); }

    const lbBody=document.querySelector("#tbl_leader tbody");
    if(lbBody) lbBody.innerHTML=rows.map(r=>`<tr><td>${r.provider}</td><td>${r.region}</td><td>${r.gpu}</td><td><span class="pill">${r.type}</span></td><td>${r.duration||"–"}</td><td>${r.count!=null?r.count:"–"}</td><td class="right">${fmt.money(r.price)}</td><td class="right">${r.score!=null?Number(r.score).toFixed(1):"–"}</td><td class="right">${fmt.date(r.ts)}</td></tr>`).join("");

    const cbody=document.querySelector("#tbl_comp tbody");
    if(cbody) cbody.innerHTML=state.snap.map(r=>{
      const lo=r.price_lo??r.price_lo_usd??r.lo, md=r.price_md??r.price_md_usd??r.md, hi=r.price_hi??r.price_hi_usd??r.hi;
      return `<tr>
        <td>${r.gpu_model||r.gpu||""}</td>
        <td>${r.provider_type||r.provider_type_label||""}</td>
        <td>${r["$/GPU-hr"]||(lo&&hi?`$${lo}–$${hi}`:"")}</td>
        <td>${r.TOTAL||r.total||""}</td>
        <td class="right">${lo??""}</td><td class="right">${md??""}</td><td class="right">${hi??""}</td>
        <td class="right">${r.term_hours||r.term_hrs||""}</td>
        <td class="right">${r.gpu_count||r.gpus||""}</td>
        <td>${r.used_region||r.region||""}</td>
        <td class="right">${r.n_quotes||r.quotes||""}</td>
        <td>${r.source||""}</td>
      </tr>`;
    }).join("");

    const pp=state.predict||{}; const moneyOrDash=v=>(v==null||isNaN(v))?"–":`$${Number(v).toFixed(2)}`;
    set("p10",moneyOrDash(pp.p10)); set("p25",moneyOrDash(pp.p25)); set("p50",moneyOrDash(pp.p50)); set("p7590",`${moneyOrDash(pp.p75||pp.p50)} / ${moneyOrDash(pp.p90)}`);
  }

  // ---------------------- QUICK CALC ----------------------
  function initQuickCalc(){
    const gpus=uniq(state.scores.map(r=>r.gpu)).sort(), regs=uniq(state.scores.map(r=>r.region)).sort();
    const setOpts=(el,arr)=>{ if(el) el.innerHTML=arr.map(v=>`<option>${v}</option>`).join(""); };
    const qc_gpu=document.getElementById("qc_gpu"), qc_region=document.getElementById("qc_region"), qc_count=document.getElementById("qc_count"), qc_dur=document.getElementById("qc_dur");
    if(!qc_gpu || !qc_region || !qc_count || !qc_dur) return; // hidden if you didn’t add the quick calc table
    setOpts(qc_gpu,gpus); setOpts(qc_region,regs); setOpts(qc_count,[8,16,32,64]); setOpts(qc_dur,["1 hour","1 day","1 week","1 month"]);
  }

  // ---------------------- BENCHMARK ----------------------
  function setOptionsPlain(el,arr){ if(el) el.innerHTML=arr.map(v=>`<option>${v}</option>`).join(""); }
  function kde(values,gridN=160){ const n=values.length; if(!n) return {x:[],y:[]}; const mean=values.reduce((a,b)=>a+b,0)/n; const s2=values.reduce((a,b)=>a+(b-mean)**2,0)/Math.max(1,n-1); const sd=Math.sqrt(Math.max(s2,1e-9)); const h=1.06*sd*Math.pow(n,-1/5); const minV=Math.min(...values), maxV=Math.max(...values); const pad=0.15*(maxV-minV||1); const lo=minV-pad, hi=maxV+pad; const x=Array.from({length:gridN},(_,i)=> lo + (i/(gridN-1))*(hi-lo)); const y=x.map(xi=>{ let s=0; for(const v of values){ const u=(xi-v)/h; s+=Math.exp(-0.5*u*u);} return s/(n*h*Math.sqrt(2*Math.PI));}); const ymax=Math.max(...y,1e-9); return {x, y:y.map(d=>d/ymax)}; }

  function initBenchmarkUI(){
    const rows=state.scores;
    const gpus=[...new Set(rows.map(r=>r.gpu))].sort(), regions=[...new Set(rows.map(r=>r.region))].sort(), types=[...new Set(rows.map(r=>r.type))].sort(), durs=[...new Set(rows.map(r=>r.duration))].sort(), counts=[...new Set(rows.map(r=>r.count).filter(Boolean))].sort((a,b)=>a-b);
    setOptionsPlain(document.getElementById("bm_gpu"), gpus.length?gpus:["H100","H200"]);
    setOptionsPlain(document.getElementById("bm_region"), regions);
    setOptionsPlain(document.getElementById("bm_type"), types);
    setOptionsPlain(document.getElementById("bm_duration"), durs);
    setOptionsPlain(document.getElementById("bm_count"), counts);
    const bm_gpu=document.getElementById("bm_gpu"), bm_region=document.getElementById("bm_region"), bm_type=document.getElementById("bm_type"), bm_duration=document.getElementById("bm_duration"), bm_count=document.getElementById("bm_count");
    if(bm_gpu) bm_gpu.value=gpus.includes("H100")?"H100":(gpus[0]||""); if(bm_region) bm_region.value=regions.includes("Global")?"Global":(regions[0]||""); if(bm_type) bm_type.value=types.find(t=>/On-Demand/i.test(t))||(types[0]||""); if(bm_duration) bm_duration.value=durs.find(d=>/1h|1 hour/i.test(d))||(durs[0]||""); if(bm_count) bm_count.value=counts.includes(8)?8:(counts[0]||"");
    const run=()=>{ runBenchmark(); renderForecast(); };
    const bm_run=document.getElementById("bm_run"); if(bm_run) bm_run.onclick=run;
    ["bm_gpu","bm_region","bm_type","bm_duration","bm_count"].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener("change", run); });
    runBenchmark();
  }

  function runBenchmark(){
    const bm_gpu=document.getElementById("bm_gpu"), bm_region=document.getElementById("bm_region"), bm_type=document.getElementById("bm_type"), bm_duration=document.getElementById("bm_duration"), bm_count=document.getElementById("bm_count");
    if(!bm_gpu||!bm_region||!bm_type||!bm_duration||!bm_count) return;
    const gpu=bm_gpu.value, reg0=bm_region.value, typ0=bm_type.value, dur0=bm_duration.value, cnt0=bm_count.value;
    let sample=state.scores.filter(r=>r.gpu===gpu&&r.region===reg0&&r.type===typ0&&r.duration===dur0&&String(r.count)===String(cnt0));
    let note=`exact slice (${sample.length})`;
    if(sample.length<8){ sample=state.scores.filter(r=>r.gpu===gpu&&r.region===reg0&&r.type===typ0&&r.duration===dur0); note="relaxed: drop count"; }
    if(sample.length<8){ sample=state.scores.filter(r=>r.gpu===gpu&&r.region===reg0&&r.type===typ0); note="relaxed: drop duration + count"; }
    if(sample.length<8){ sample=state.scores.filter(r=>r.gpu===gpu&&r.type===typ0); note="relaxed: drop region + duration + count"; }
    if(sample.length<8){ sample=state.scores.filter(r=>r.gpu===gpu); note="relaxed: GPU only"; }

    const vals=sample.map(r=>r.price).filter(Number.isFinite).sort((a,b)=>a-b);
    const q=(sorted,ps)=>{ const n=sorted.length; if(!n) return ps.map(()=>NaN); return ps.map(p=>{ if(n===1) return sorted[0]; const idx=(n-1)*p, lo=Math.floor(idx), hi=Math.ceil(idx); if(lo===hi) return sorted[lo]; const w=idx-lo; return sorted[lo]*(1-w)+sorted[hi]*w;});};
    const [p10,p25,p50,p75,p90]=q(vals,[0.10,0.25,0.50,0.75,0.90]);
    const money=n=>isFinite(n)?`$${n.toFixed(2)}`:"–"; const set=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
    set("bm_p10",money(p10)); set("bm_p25",money(p25)); set("bm_p50",money(p50)); set("bm_p75",money(p75)); set("bm_p90",money(p90)); set("bm_big",money(p50));
    let noteTxt=`Samples: ${vals.length} (${note})`; let conf="Low";
    if(isFinite(p50)&&isFinite(p25)&&isFinite(p75)&&vals.length){ const iqr=Math.max(0,p75-p25); const disp=iqr/Math.max(p50,1e-9); conf=(vals.length>=40&&disp<0.25)?"High":(vals.length>=20&&disp<0.40)?"Medium":"Low"; noteTxt+=` · Confidence: ${conf}`; } set("bm_note",noteTxt);
    const dealEl=document.getElementById("bm_deal"); if(dealEl){ dealEl.style.display="none"; dealEl.className="badge"; if(vals.length&&isFinite(p25)&&isFinite(p75)){ const cheapest=vals[0]; if(cheapest<p25){ dealEl.textContent="Deal (book now)"; dealEl.classList.add("best"); dealEl.style.display="inline-block"; } else if(cheapest>p75){ dealEl.textContent="Rich (likely cheaper later)"; dealEl.classList.add("warn"); dealEl.style.display="inline-block"; } else { dealEl.textContent="Fair"; dealEl.style.display="inline-block"; } } }
    const {x,y}=kde(vals); const canvas=document.getElementById("bm_chart"); if(canvas&&window.Chart){ const ctx=canvas.getContext("2d"); if(window._bmChart) window._bmChart.destroy(); window._bmChart=new Chart(ctx,{ type:'line', data:{labels:x, datasets:[{label:'Normalized Price Distribution', data:y, fill:true, tension:0.35, pointRadius:0, borderWidth:2}]}, options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{min:0,max:1,ticks:{callback:v=>v.toFixed(1)}}, x:{ticks:{callback:(v)=>'$'+Number(x[v]).toFixed(2), autoSkip:true, maxRotation:0}}}, interaction:{mode:'index',intersect:false} }); }
  }

  // ---------------------- FORECAST (upload/generate/trainer + AUTO) ----------------------
  function csvFromRows(rows){ const header=["gpu_model","region","type","duration","gpu_count","date_utc","p10","p25","p50","p75","p90"]; const lines=[header.join(",")].concat(rows.map(r=>[r.gpu,r.region,r.type,r.duration,r.count,r.date,r.p10.toFixed(2),r.p25.toFixed(2),r.p50.toFixed(2),r.p75.toFixed(2),r.p90.toFixed(2)].join(","))); return lines.join("\n"); }
  function downloadText(name,text,mime="text/plain"){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:mime})); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }

  function bindForecastUX(){
    const elEmpty=document.getElementById("fcEmpty"), elChart=document.getElementById("fc_chart"), elUpload=document.getElementById("fcUpload"), elGen=document.getElementById("fcGen"), elTpl=document.getElementById("fcTpl"), elTrainer=document.getElementById("fcTrainer");
    if(elUpload){ elUpload.onchange=async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); const rows=parseCSV(txt).map(r=>({ gpu:pick(r,["gpu_model","gpu"]), region:r.region, type:r.type, duration:r.duration, count:Number(pick(r,["gpu_count","count"],0)), date:pick(r,["date_utc","date","ts"]), p10:Number(r.p10), p25:Number(r.p25), p50:Number(r.p50), p75:Number(r.p75), p90:Number(r.p90) })).filter(r=>r.date&&isFinite(r.p50)); state.forecast=rows; elEmpty.style.display="none"; elChart.style.display="block"; renderForecast(); }; }
    if(elGen){ elGen.onclick=()=>{ const gpu=document.getElementById("bm_gpu")?.value||"H100", reg=document.getElementById("bm_region")?.value||"Global", typ=document.getElementById("bm_type")?.value||"On-Demand", dur=document.getElementById("bm_duration")?.value||"1 hour", cnt=Number(document.getElementById("bm_count")?.value||8); const getN=id=>Number((document.getElementById(id)?.textContent||"").replace(/[^0-9.]/g,""))||NaN; const p10=getN("bm_p10"), p25=getN("bm_p25"), p50=getN("bm_p50"), p75=getN("bm_p75"), p90=getN("bm_p90"); const base50=isFinite(p50)?p50:(state.scores.map(r=>r.price).sort((a,b)=>a-b)[Math.floor(state.scores.length/2)]||1); const base10=isFinite(p10)?p10:base50*0.85, base25=isFinite(p25)?p25:base50*0.92, base75=isFinite(p75)?p75:base50*1.08, base90=isFinite(p90)?p90:base50*1.15; const now=new Date(); const rows=[]; for(let h=1; h<=72; h++){ const d=new Date(now.getTime()+h*3600*1000); const sin=Math.sin((h/24)*Math.PI*2); const drift=1+0.02*(h/72 - 0.5); const jitter=v=>(v*drift*(1+0.01*sin)); rows.push({gpu, region:reg, type:typ, duration:dur, count:cnt, date:d.toISOString(), p10:jitter(base10), p25:jitter(base25), p50:jitter(base50), p75:jitter(base75), p90:jitter(base90)});} state.forecast=rows; document.getElementById("fcEmpty").style.display="none"; document.getElementById("fc_chart").style.display="block"; renderForecast(); }; }
    if(elTpl){ elTpl.onclick=()=>{ const gpu=document.getElementById("bm_gpu")?.value||"H100", reg=document.getElementById("bm_region")?.value||"Global", typ=document.getElementById("bm_type")?.value||"On-Demand", dur=document.getElementById("bm_duration")?.value||"1 hour", cnt=Number(document.getElementById("bm_count")?.value||8); const now=new Date(); const sample=[]; for(let h=1; h<=3; h++){ const d=new Date(now.getTime()+h*3600*1000); sample.push({gpu, region:reg, type:typ, duration:dur, count:cnt, date:d.toISOString(), p10:1.00, p25:1.10, p50:1.20, p75:1.30, p90:1.40}); } downloadText("forecast_template.csv", csvFromRows(sample), "text/csv"); }; }
    if(elTrainer){ elTrainer.onclick=()=> downloadText("train_forecast.py", TRAINER_PY, "text/x-python"); }
  }

  // LightGBM trainer script (downloaded)
  const TRAINER_PY=`# -*- coding: utf-8 -*-
import pandas as pd, numpy as np, lightgbm as lgb
from pathlib import Path
DERIVED=Path("data/derived")
HIST=DERIVED/"provider_scores_history.csv"
OUT=DERIVED/"forecast.csv"
def load_history():
    df=pd.read_csv(HIST, parse_dates=["timestamp"])
    df=df.rename(columns={"gpu_model":"gpu","effective_price_usd_per_gpu_hr":"price"})
    df=df.sort_values("timestamp"); df["slice"]=df[["gpu","region","type","duration"]].agg("|".join,axis=1); return df
def add_features(df):
    df["hour"]=df["timestamp"].dt.hour; df["dow"]=df["timestamp"].dt.dayofweek
    def _lags(g):
        for k in [1,24,168]: g[f"lag_{k}"]=g["price"].shift(k)
        for w in [6,24,72,168]:
            g[f"roll_mean_{w}"]=g["price"].rolling(w,min_periods=3).mean()
            g[f"roll_std_{w}"]=g["price"].rolling(w,min_periods=3).std()
        return g
    return df.groupby("slice",group_keys=False).apply(_lags)
def fit_quantile(train,valid,feats,alpha):
    params=dict(objective="quantile",alpha=alpha,learning_rate=0.05,num_leaves=64,feature_fraction=0.9,bagging_fraction=0.8,bagging_freq=1)
    dtrain=lgb.Dataset(train[feats],label=train["price"]); dvalid=lgb.Dataset(valid[feats],label=valid["price"])
    return lgb.train(params,dtrain,num_boost_round=600,valid_sets=[dvalid],callbacks=[lgb.early_stopping(60,verbose=False)])
def future_design(df_slice,feats,models,horizon=72):
    hist=df_slice.copy().sort_values("timestamp").tail(168+72).dropna()
    rows=[]; last_ts=hist["timestamp"].max()
    for i in range(1,horizon+1):
        t=last_ts+pd.Timedelta(hours=i); row={"timestamp":t,"hour":t.hour,"dow":t.dayofweek}
        def lag(gap): return hist.iloc[-gap]["price"] if len(hist)>=gap else np.nan
        for k in [1,24,168]: row[f"lag_{k}"]=lag(k)
        for w in [6,24,72,168]: tail=hist["price"].tail(w); row[f"roll_mean_{w}"]=tail.mean(); row[f"roll_std_{w}"]=tail.std()
        X=pd.DataFrame([row]); mid=models[0.5].predict(X[feats])[0]
        rows.append((row,mid)); hist=pd.concat([hist,pd.DataFrame([{"timestamp":t,"price":mid}])],ignore_index=True)
    return pd.DataFrame([r for r,_ in rows])
def main():
    df=add_features(load_history()).dropna()
    feats=[c for c in df.columns if c not in ["timestamp","price","slice","gpu","region","type","duration","gpu_count"]]
    cut=df["timestamp"].quantile(0.85); train,valid=df[df["timestamp"]<=cut], df[df["timestamp"]>cut]
    models={q:fit_quantile(train,valid,feats,q) for q in [0.1,0.25,0.5,0.75,0.9]}
    out_rows=[]
    for slc,g in df.groupby("slice"):
        gpu,region,typ,dur=slc.split("|")
        Xf=future_design(g[["timestamp","price"]+feats],feats,models,72)
        preds={q:models[q].predict(Xf[feats]) for q in [0.1,0.25,0.5,0.75,0.9]}
        ts=pd.date_range(df["timestamp"].max()+pd.Timedelta(hours=1),periods=72,freq="H")
        for i,t in enumerate(ts):
            out_rows.append(dict(gpu_model=gpu,region=region,type=typ,duration=dur,gpu_count=8,date_utc=t.tz_localize("UTC").isoformat(),p10=preds[0.1][i],p25=preds[0.25][i],p50=preds[0.5][i],p75=preds[0.75][i],p90=preds[0.9][i]))
    OUT.parent.mkdir(parents=True,exist_ok=True); pd.DataFrame(out_rows).to_csv(OUT,index=False); print(f"Wrote {OUT} with {len(out_rows)} rows.")
if __name__=="__main__": main()
`;

  let _fcChart;
  function renderForecastInner(){
    const fc=state.forecast||[]; const noteEl=document.getElementById("fcNote"); const metaEl=document.getElementById("fcMeta"); const canvas=document.getElementById("fc_chart");
    if(!fc.length){ if(noteEl) noteEl.textContent="No forecast.csv found or no rows. Add it via the training step."; return; }
    const rows=[...fc].sort((a,b)=> new Date(a.date)-new Date(b.date));
    const labels=rows.map(r=>{ const d=new Date(r.date); const mm=d.toLocaleString(undefined,{month:'short'}); const dd=d.getDate(); const hh=String(d.getHours()).padStart(2,'0'); return `${mm} ${dd} ${hh}:00`; });
    const p10=rows.map(r=>Number(r.p10)), p50=rows.map(r=>Number(r.p50)), p90=rows.map(r=>Number(r.p90));
    if(metaEl){ const u=rows[0]||{}; metaEl.textContent=`${u.gpu||u.gpu_model||"–"} · ${u.region||"–"} · ${u.type||"–"} · ${u.duration||"–"} · ${u.count||u.gpu_count||"–"} GPUs`; }
    if(noteEl) noteEl.textContent=`Points: ${rows.length}. Band shows P10–P90; line shows P50.`;
    if(!window.Chart||!canvas) return;
    const ctx=canvas.getContext("2d"); if(_fcChart) _fcChart.destroy();
    _fcChart=new Chart(ctx,{ type:'line', data:{ labels, datasets:[ {label:'P10', data:p10, pointRadius:0, borderWidth:1, tension:0.25, fill:false, hidden:true}, {label:'P10–P90 band', data:p90, pointRadius:0, borderWidth:0, tension:0.25, fill:{target:0}}, {label:'P50', data:p50, pointRadius:0, borderWidth:2, tension:0.25} ]}, options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ ticks:{ callback:v=>"$"+Number(v).toFixed(2)}}, x:{ ticks:{ autoSkip:true, maxRotation:0 }}}, interaction:{ mode:'index', intersect:false } } );
  }

  // ----- AUTO-FORECAST from scores if forecast.csv is missing -----
  function computeAutoForecastFromScores(hours=72){
    const gpu=document.getElementById("bm_gpu")?.value||"H100", reg=document.getElementById("bm_region")?.value||"Global", typ=document.getElementById("bm_type")?.value||"On-Demand", dur=document.getElementById("bm_duration")?.value||"1 hour", cnt=Number(document.getElementById("bm_count")?.value||8);
    let rows=state.scores.filter(r=> r.gpu===gpu&&r.region===reg&&r.type===typ&&r.duration===dur&&String(r.count)===String(cnt));
    if(rows.length<12) rows=state.scores.filter(r=> r.gpu===gpu&&r.region===reg&&r.type===typ&&r.duration===dur);
    if(rows.length<12) rows=state.scores.filter(r=> r.gpu===gpu&&r.region===reg&&r.type===typ);
    if(rows.length<12) rows=state.scores.filter(r=> r.gpu===gpu);
    if(!rows.length) return [];
    const points=rows.map(r=>({ts:new Date(r.ts||Date.now()), price:Number(r.price)})).filter(p=>isFinite(p.price)).sort((a,b)=>a.ts-b.ts);
    if(!points.length) return [];
    const vals=points.map(p=>p.price).sort((a,b)=>a-b);
    const q=(arr,p)=>{ const n=arr.length; if(!n) return NaN; if(n===1) return arr[0]; const i=(n-1)*p, lo=Math.floor(i), hi=Math.ceil(i); if(lo===hi) return arr[lo]; const w=i-lo; return arr[lo]*(1-w)+arr[hi]*w; };
    const P25=q(vals,0.25), P50=q(vals,0.50), P75=q(vals,0.75); const iqr=Math.max(1e-9, P75-P25); const base=isFinite(P50)?P50:vals[Math.floor(vals.length/2)];
    const byHour=new Array(24).fill(null).map(()=>[]); points.forEach(p=>byHour[p.ts.getUTCHours()].push(p.price));
    const med=a=>{ if(!a.length) return NaN; const s=[...a].sort((x,y)=>x-y); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; };
    const hourMed=byHour.map(med); const hourFactor=hourMed.map(mv=>{ if(!isFinite(mv)||!isFinite(base)||base<=0) return 1; const f=mv/base; return Math.min(1.25, Math.max(0.75, f));});
    const rel=Math.min(0.35, Math.max(0.05, iqr/Math.max(base,1e-9)));
    const band={p10:1-1.8*rel, p25:1-0.8*rel, p50:1, p75:1+0.8*rel, p90:1+1.8*rel};
    const now=new Date(); const out=[]; for(let h=1; h<=hours; h++){ const t=new Date(now.getTime()+h*3600*1000); const season=hourFactor[t.getUTCHours()]||1; const drift=1+0.02*(h/hours-0.5); const mid=base*season*drift; out.push({gpu,region:reg,type:typ,duration:dur,count:cnt,date:t.toISOString(), p10:mid*band.p10, p25:mid*band.p25, p50:mid, p75:mid*band.p75, p90:mid*band.p90}); }
    return out;
  }

  function renderForecast(){
    if(!state.forecast || !state.forecast.length){
      const auto=computeAutoForecastFromScores(72);
      if(auto.length){ state.forecast=auto; }
    }
    const fc=state.forecast||[]; const empty=document.getElementById("fcEmpty"); const canvas=document.getElementById("fc_chart");
    if(!fc.length){ if(empty) empty.style.display="block"; if(canvas) canvas.style.display="none"; bindForecastUX(); return; }
    if(empty) empty.style.display="none"; if(canvas) canvas.style.display="block"; renderForecastInner();
  }

  // ---------------------- ROI (grid) ----------------------
  const DUR_ORDER=["1 hour","1 day","1 week","1 month"]; const COUNT_ORDER=[8,16,32,64];
  function fmtMoney0(n){ return isFinite(n)?`$${Number(n).toFixed(0)}`:"–"; } function fmtRate2(n){ return isFinite(n)?`$${Number(n).toFixed(2)}`:"–"; }
  function buildBestByScenario(rows,metric){ const key=r=>[r.gpu,r.region,r.count,r.duration].join("|"); const best=new Map(); for(const r of rows){ if(!isFinite(r.total)||!isFinite(r.p_eff)||!isFinite(r.count)||!isFinite(r.hrs)) continue; const k=key(r); const cur=best.get(k); const lhs=(metric==="rate")?r.p_eff:r.total; if(!cur) best.set(k,r); else { const rhs=(metric==="rate")?cur.p_eff:cur.total; if(lhs<rhs) best.set(k,r);} } return [...best.values()]; }
  function initROIImproved(){
    if(!state.roi?.length) return;
    const gpuSel=document.getElementById("roi_gpu"), regSel=document.getElementById("roi_region"), metSel=document.getElementById("roi_metric"), reset=document.getElementById("roi_reset"), gridEl=document.getElementById("roi_grid"), detBox=document.getElementById("roi_details"), detTitle=document.getElementById("roi_detail_title"), detMeta=document.getElementById("roi_detail_meta"), detBody=document.getElementById("roi_detail_body");
    const gpus=uniq(state.roi.map(r=>r.gpu)).sort(), regs=uniq(state.roi.map(r=>r.region)).sort();
    if(gpuSel) gpuSel.innerHTML=gpus.map(g=>`<option>${g}</option>`).join(""); if(regSel) regSel.innerHTML=["All",...regs].map(r=>`<option>${r}</option>`).join(""); if(gpuSel) gpuSel.value=gpus.includes("H100")?"H100":gpus[0]; if(regSel) regSel.value="All";
    function render(){
      if(!gridEl) return;
      const gpu=gpuSel?.value||gpus[0], region=regSel?.value||"All", metric=metSel?.value||"total";
      let rows=state.roi.filter(r=>r.gpu===gpu); if(region!=="All") rows=rows.filter(r=>r.region===region);
      const best=buildBestByScenario(rows,metric);
      const durations=DUR_ORDER.filter(d=>best.some(r=>r.duration===d)); const counts=COUNT_ORDER.filter(c=>best.some(r=>r.count===c));
      if(!durations.length || !counts.length){ gridEl.style.display="block"; gridEl.innerHTML=`<div class="small" style="color:var(--sub)">No ROI scenarios match the current filters.</div>`; if(detBox) detBox.style.display="none"; return; }
      gridEl.style.display="grid"; gridEl.style.gridTemplateColumns=`160px ${counts.map(()=> "1fr").join(" ")}`;
      let html=`<div></div>${counts.map(c=>`<div class="small" style="color:var(--sub);font-weight:600">Count: ${c}</div>`).join("")}`;
      for(const d of durations){
        html+=`<div class="small" style="color:var(--sub);font-weight:600">${d}</div>`;
        for(const c of counts){
          const cell=best.find(r=> r.duration===d && r.count===c);
          if(!cell){ html+=`<div class="roiCell" style="opacity:0.5"><div class="small">–</div></div>`; continue; }
          html+=`<div class="roiCell" data-gpu="${cell.gpu}" data-region="${cell.region}" data-count="${c}" data-duration="${d}">
            <h4>${cell.provider} <span class="small" style="color:var(--sub)">· ${cell.region}</span></h4>
            <div class="total">${fmtMoney0(cell.total)}</div>
            <div class="small" style="color:var(--sub)">${fmtRate2(cell.p_eff)} / GPU-hr</div>
          </div>`;
        }
      }
      gridEl.innerHTML=html;
      gridEl.querySelectorAll('.roiCell').forEach(div=>{
        div.addEventListener('click', ()=>{
          const d=div.getAttribute('data-duration'); const c=Number(div.getAttribute('data-count')); const reg=div.getAttribute('data-region');
          const slice=rows.filter(r=> r.duration===d && r.count===c && r.region===reg);
          slice.sort((a,b)=> (metric==="rate" ? a.p_eff - b.p_eff : a.total - b.total));
          const top=slice.slice(0,3);
          if(detTitle) detTitle.textContent=`Top options — ${gpu}, ${c} GPUs, ${d}`;
          if(detMeta) detMeta.textContent=`${reg} · Metric: ${metric==="rate" ? "$/GPU-hr (derived)" : "Total cost"}`;
          if(detBody) detBody.innerHTML=top.map(r=>{ const w=Math.max(6, Math.round((r.total/Math.max(top[0].total,1e-9))*100)); return `<tr><td>${r.provider}</td><td>${r.region}</td><td class="right">${fmtRate2(r.p_eff)}</td><td class="right">${fmtMoney0(r.total)}<div class="barWrap"><div class="bar" style="width:${w}%"></div></div></td></tr>`; }).join("");
          if(detBox) detBox.style.display="block";
        });
      });
    }
    [gpuSel,regSel,metSel].forEach(el=> el && el.addEventListener('change', render));
    reset && reset.addEventListener('click', ()=>{ if(gpuSel) gpuSel.value=gpus.includes("H100")?"H100":gpus[0]; if(regSel) regSel.value="All"; if(metSel) metSel.value="total"; render();});
    render();
  }

  // ---------------------- BOOT ----------------------
  loadAll().catch(e=>{ showErr("Failed to load: "+e.message); });
})();
});
</script>
</body>
</html>




