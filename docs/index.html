<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Price-IQ</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --bg:#0f1216; --panel:#171b21; --muted:#202532; --text:#e7edf3; --sub:#9fb0c3;
    --accent:#7bd7ff; --ok:#27d980; --warn:#ffd166; --danger:#ff6b6b;
    --chip:#222838; --chipStroke:#2b3143; --chipText:#cfd9e5;
    --row:#12161c; --rowAlt:#141922; --badge:#283042;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  header h1{font-size:26px;margin:0}
  .updated{margin-left:auto;font-size:12px;color:var(--sub);background:var(--panel);border:1px solid var(--chipStroke);padding:6px 10px;border-radius:10px}
  .row{display:grid;gap:12px}
  .hero{grid-template-columns:1fr 1fr 1fr 1fr 1fr 110px}
  .tileRow{grid-template-columns:1fr 1fr 1fr 1fr}
  @media (max-width:980px){ .hero{grid-template-columns:1fr 1fr} .tileRow{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:12px}
  .select, .btn, .inp{width:100%;appearance:none;background:var(--chip);border:1px solid var(--chipStroke);color:var(--text);padding:10px 12px;border-radius:10px}
  .select{padding-right:36px;background-image:linear-gradient(45deg,transparent 50%,var(--sub) 50%),linear-gradient(135deg,var(--sub) 50%,transparent 50%),linear-gradient(to right,transparent,transparent);
          background-position:calc(100% - 18px) 16px,calc(100% - 12px) 16px,100% 0;background-size:6px 6px,6px 6px,2.5em 2.5em;background-repeat:no-repeat}
  .btn{cursor:pointer}
  .btn.clear{background:#1d2430;border-color:#2a3244}
  .stat{display:flex;flex-direction:column;gap:6px}
  .stat h4{margin:0;color:var(--sub);font-weight:600}
  .stat .val{font-size:28px;font-weight:700}
  .stat .sub{color:var(--sub);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);color:var(--sub);font-size:12px;border:1px solid var(--chipStroke)}
  .badge.best{background:rgba(39,217,128,0.12); color:#9ff3c8; border-color:rgba(39,217,128,0.25)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{color:var(--sub);font-weight:600;text-align:left;font-size:12px;padding:0 10px 6px}
  tbody tr{background:var(--row);border:1px solid var(--muted)}
  tbody tr:nth-child(even){background:var(--rowAlt)}
  td{padding:12px 10px;vertical-align:middle}
  td .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chipStroke);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--chipText)}
  .right{justify-self:end;text-align:right}
  .sectionTitle{display:flex;align-items:center;gap:10px;margin:18px 4px 8px}
  .small{font-size:12px;color:var(--sub)}
  .debug{display:none}
  .debug.on{display:block}
  .controls{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .control{display:flex;flex-direction:column;gap:6px}
  .control label{font-size:11px;color:var(--sub);padding-left:2px}
  /* ROI bar */
  .barWrap{margin-top:6px;height:6px;background:rgba(255,255,255,0.05);border:1px solid var(--chipStroke);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg, var(--accent), #89e1ff)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Price-IQ</h1>
      <span class="small">Auto-generated from <code>data/derived/</code></span>
      <div class="updated" id="asOf">Updated: —</div>
    </header>

    <!-- HERO FILTERS (labeled) -->
    <div class="row hero">
      <div class="control"><label>GPU</label><select id="f_gpu" class="select"></select></div>
      <div class="control"><label>Region</label><select id="f_region" class="select"></select></div>
      <div class="control"><label>Type</label><select id="f_type" class="select"></select></div>
      <div class="control"><label>Duration</label><select id="f_duration" class="select"></select></div>
      <div class="control"><label>GPU Count</label><select id="f_count" class="select"></select></div>
      <div class="control"><label>&nbsp;</label><button class="btn clear" id="btnClear">Clear</button></div>
    </div>

    <!-- KPI TILES -->
    <div class="row tileRow" style="margin-top:12px">
      <div class="card stat">
        <h4>Cheapest / GPU-hr</h4>
        <div class="val" id="kpi_low">–</div>
        <div class="sub" id="kpi_low_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Median / GPU-hr</h4>
        <div class="val" id="kpi_med">–</div>
        <div class="sub" id="kpi_med_sub"> </div>
      </div>
      <div class="card stat">
        <h4>Providers covered</h4>
        <div class="val" id="kpi_prov">–</div>
        <div class="sub" id="kpi_prov_sub">Unique provider names in current filter.</div>
      </div>
      <div class="card stat">
        <h4>Entries</h4>
        <div class="val" id="kpi_rows">0</div>
        <div class="sub">Rows displayed in leaderboard.</div>
      </div>
    </div>

    <!-- DATA STATUS (toggle) -->
    <div class="sectionTitle" style="margin-top:18px">
      <div class="switch small">
        <input type="checkbox" id="toggleDebug"><label for="toggleDebug">Show data status (debug)</label>
      </div>
    </div>
    <div class="card debug" id="debugPanel"><div id="debugLines" class="small"></div></div>

    <!-- LEADERBOARD -->
    <div class="sectionTitle">
      <h3 style="margin:0">Leaderboard (Price-IQ)</h3>
      <span class="small" id="lbSort">Sorted by price ↑</span>
    </div>
    <div class="card">
      <table id="tbl_leader">
        <thead>
          <tr>
            <th>Provider</th><th>Region</th><th>GPU</th><th>Type</th>
            <th>Duration</th><th>Count</th>
            <th class="right">$/GPU-hr</th><th class="right">Score</th><th class="right">Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ROI: Cheapest total cost -->
    <div class="sectionTitle">
      <h3 style="margin:0">ROI (Cheapest total cost)</h3>
      <span class="small">from <code>roi_comparison.csv</code> · <span id="roiMeta"></span></span>
    </div>
    <div class="card">
      <table id="tbl_roi">
        <thead>
          <tr>
            <th>GPU</th><th>Count</th><th>Duration</th><th>Provider</th>
            <th>Region</th><th class="right">$/GPU-hr</th><th class="right">Total cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- QUICK CALC -->
    <div class="sectionTitle">
      <h3 style="margin:0">ROI Calculator (quick)</h3>
    </div>
    <div class="card">
      <div class="controls" style="flex-wrap:wrap;margin-bottom:10px">
        <select id="qc_gpu"   class="select" style="min-width:160px"></select>
        <select id="qc_region"class="select" style="min-width:160px"></select>
        <select id="qc_count" class="select" style="min-width:120px"></select>
        <select id="qc_dur"   class="select" style="min-width:160px"></select>
        <label class="switch small"><input type="checkbox" id="qc_usePred"> Use predictions (P50) if available</label>
        <button class="btn" id="btnCalc">Calculate</button>
      </div>
      <table id="tbl_qc">
        <thead>
          <tr>
            <th>Provider</th><th>Region</th><th class="right">$/GPU-hr</th><th class="right">Total cost</th><th class="right">Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row tileRow" style="margin-top:12px">
        <div class="card stat"><h4>Predicted price (P10)</h4><div class="val" id="p10">–</div></div>
        <div class="card stat"><h4>Predicted price (P25)</h4><div class="val" id="p25">–</div></div>
        <div class="card stat"><h4>Predicted price (P50)</h4><div class="val" id="p50">–</div></div>
        <div class="card stat"><h4>Predicted price (P75 / P90)</h4><div class="val" id="p7590">– / –</div></div>
      </div>
    </div>

    <!-- PROVIDER HISTORY (H100/H200) -->
    <div class="sectionTitle">
      <h3 style="margin:0">Provider history</h3>
      <span class="small">from <code>data/history/*.csv</code></span>
    </div>
    <div class="card">
      <div class="controls" style="flex-wrap:wrap;margin-bottom:8px">
        <div class="control" style="min-width:200px"><label>Provider</label><select id="hist_provider" class="select"></select></div>
        <div class="control" style="min-width:140px"><label>GPU</label>
          <select id="hist_gpu" class="select"><option>H100</option><option>H200</option></select>
        </div>
        <div class="control" style="min-width:140px"><label>Duration</label>
          <select id="hist_dur" class="select"><option>All</option><option>1h</option><option>1 hour</option><option>1 day</option><option>1 week</option><option>1 month</option></select>
        </div>
        <div class="control" style="min-width:120px"><label>GPU Count</label>
          <select id="hist_cnt" class="select"><option>All</option><option>1</option><option>2</option><option>4</option><option>8</option><option>16</option><option>32</option><option>64</option></select>
        </div>
        <div class="control" style="min-width:160px"><label>Range</label>
          <select id="hist_range" class="select">
            <option value="today">Today</option>
            <option value="2">Last 2 days</option>
            <option value="3">Last 3 days</option>
            <option value="5">Last 5 days</option>
            <option value="7">Last 7 days</option>
            <option value="all">All days</option>
          </select>
        </div>
      </div>
      <canvas id="histChart" height="120"></canvas>
    </div>

    <!-- SNAPSHOT -->
    <div class="sectionTitle">
      <h3 style="margin:0">Compute Calculator Snapshot</h3>
      <span class="small">from <code>compute_calculator_snapshot.csv</code></span>
    </div>
    <div class="card">
      <table id="tbl_comp">
        <thead>
          <tr>
            <th>GPU</th><th>Provider type</th><th>$ / GPU-hr</th><th>TOTAL (term)</th>
            <th class="right">lo</th><th class="right">md</th><th class="right">hi</th>
            <th class="right">term hrs</th><th class="right">GPUs</th><th>Region</th><th class="right">#quotes</th><th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="small" style="margin:16px 4px 40px">
      Tip: serve over HTTP (e.g. <code>python -m http.server</code>). Data loads from <code>data/derived/</code> and <code>data/history/</code>.
      Toggle debug to see which files were found.
    </p>
  </div>

<script>
(function(){
  // ---------------------- DEBUG LOGGER ----------------------
  const dbg = [];
  function logDbg(msg){
    dbg.push(msg);
    const el = document.getElementById("debugLines");
    if (el) el.innerHTML = dbg.map(s=>`<div>${s}</div>`).join("");
  }
  document.getElementById("toggleDebug").addEventListener("change",(e)=>{
    document.getElementById("debugPanel").classList.toggle("on", e.target.checked);
  });

  // ---------------------- UTILS ----------------------
  const fmt = {
    money:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(2)}`,
    money0:n=> n==null||isNaN(n) ? '–' : `$${Number(n).toFixed(0)}`,
    num:n  => n==null||isNaN(n) ? '–' : Number(n).toLocaleString(),
    date:s => s? String(s).replace('T',' ').replace('Z',''): '–'
  };
  function numify(x){ return x==null ? NaN : Number(String(x).replace(/[^\d.\-]/g,"")); }
  function parseCSV(txt){
    const lines = txt.replace(/^\uFEFF/,'').trim().split(/\r?\n/);
    if (!lines.length) return [];
    const header = lines.shift().split(",").map(h=>h.trim());
    return lines.filter(Boolean).map(line=>{
      const cells = line.split(",").map(s=>s.trim());
      const o={}; header.forEach((h,i)=>o[h]=cells[i]??"");
      return o;
    });
  }
  const uniq = arr => [...new Set(arr)];
  const byNumAsc = key => (a,b)=> (+a[key]||1e12)-(+b[key]||1e12);

  // ---------------------- ROBUST PATHS ----------------------
  async function tryFetch(url){
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error(r.status+" "+url);
    return r;
  }
  const DER_BASES = ["data/derived/","./data/derived/","../data/derived/","docs/data/derived/","./docs/data/derived/","/data/derived/","/docs/data/derived/"];
  const HIS_BASES = ["data/history/","./data/history/","../data/history/","docs/data/history/","./docs/data/history/","/data/history/","/docs/data/history/"];
  async function getDerived(file){
    for(const b of DER_BASES){
      try{ const r=await tryFetch(b+file); logDbg("✅ "+b+file); return r; }catch(e){}
    }
    logDbg("❌ MISSING: "+file); throw new Error("Missing "+file);
  }
  async function getHistory(file){
    for(const b of HIS_BASES){
      try{ const r=await tryFetch(b+file); logDbg("✅ "+b+file); return r; }catch(e){}
    }
    logDbg("❌ MISSING (history): "+file); throw new Error("Missing "+file);
  }

  // ---------------------- STATE ----------------------
  const state = {
    scores:[], roi:[], predict:null, snap:[],
    filters: {gpu:"All", region:"All", type:"On-Demand", duration:"All", count:"All"}
  };

  // ---------------------- LOAD DERIVED ----------------------
  const files = {
    scores : "provider_scores_latest.csv",
    roi    : "roi_comparison.csv",
    predict: "price_predict_snapshot.json",
    snap   : "compute_calculator_snapshot.csv"
  };

  async function loadAll(){
    try{
      const txt = await (await getDerived(files.scores)).text();
      state.scores = parseCSV(txt).map(r=>({
        provider:r.provider, region:r.region, gpu:r.gpu_model, type:r.type, duration:r.duration,
        count: r.gpu_count ? Number(r.gpu_count) : null,
        price: numify(r.effective_price_usd_per_gpu_hr),
        score: r.priceiq_score ? Number(r.priceiq_score) : null,
        ts: r.timestamp
      })).filter(r=>isFinite(r.price));
      logDbg(`rows(scores): ${state.scores.length}`);
    }catch(e){ logDbg("scores load error: "+e); }

    try{
      const txt = await (await getDerived(files.roi)).text();
      state.roi = parseCSV(txt).map(r=>({
        gpu:r.gpu_model, count:Number(r.gpu_count), duration:r.duration,
        provider:r.best_provider, region:r.best_region,
        p:Number(r.price_per_gpu_hr), total:Number(r.total_cost_usd), ts:r.timestamp
      })).filter(r=>isFinite(r.total));
      logDbg(`rows(roi): ${state.roi.length}`);
    }catch(e){ logDbg("roi load error: "+e); }

    try{ state.predict = await (await getDerived(files.predict)).json(); logDbg("predict: ok"); }
    catch(e){ logDbg("predict not found (ok)"); }

    try{ const txt = await (await getDerived(files.snap)).text(); state.snap = parseCSV(txt); logDbg(`rows(snapshot): ${state.snap.length}`); }
    catch(e){ logDbg("snapshot load error: "+e); }

    initFilters();
    hydrateAll();
    initQuickCalc(); // ensure QC populated + run
    initHistoryUI();
  }

  // ---------------------- FILTERS + KPI ----------------------
  function setOptions(el, arr, withAll=true){
    const vals = withAll ? ["All", ...arr] : arr;
    el.innerHTML = vals.map(v=>`<option>${v}</option>`).join("");
  }

  function initFilters(){
    const gpus = uniq(state.scores.map(r=>r.gpu)).sort();
    const regs = uniq(state.scores.map(r=>r.region)).sort();
    const types= uniq(state.scores.map(r=>r.type)).sort();
    const durs = uniq(state.scores.map(r=>r.duration)).sort();
    const cnts = uniq(state.scores.map(r=>r.count).filter(Boolean)).sort((a,b)=>a-b);

    const gpuSel=document.getElementById("f_gpu");
    const regSel=document.getElementById("f_region");
    const typSel=document.getElementById("f_type");
    const durSel=document.getElementById("f_duration");
    const cntSel=document.getElementById("f_count");

    setOptions(gpuSel,gpus);
    setOptions(regSel,regs);
    setOptions(typSel,types);
    setOptions(durSel,durs);
    setOptions(cntSel,cnts);

    gpuSel.value = gpus.includes("H100") ? "H100" : (gpus[0]||"All");
    typSel.value = types.includes("On-Demand") ? "On-Demand" : "All";
    regSel.value="All"; durSel.value="All"; cntSel.value="All";
    state.filters={gpu:gpuSel.value, region:"All", type:typSel.value, duration:"All", count:"All"};

    [gpuSel,regSel,typSel,durSel,cntSel].forEach((el,i)=>{
      const keys=["gpu","region","type","duration","count"]; const k=keys[i];
      el.addEventListener("change", ()=>{ state.filters[k]=el.value; hydrateAll(); });
    });

    document.getElementById("btnClear").onclick=()=>{
      gpuSel.value = gpus.includes("H100") ? "H100" : (gpus[0]||"All");
      typSel.value = types.includes("On-Demand") ? "On-Demand" : "All";
      regSel.value="All"; durSel.value="All"; cntSel.value="All";
      state.filters={gpu:gpuSel.value, region:"All", type:typSel.value, duration:"All", count:"All"};
      hydrateAll();
    };

    const latest = state.scores.map(r=>r.ts).filter(Boolean).sort().pop();
    document.getElementById("asOf").textContent = "Updated: " + (latest ? fmt.date(latest) : new Date().toISOString().replace('T',' ').replace('Z',''));
  }

  function applyFilters(rows){
    const f=state.filters;
    return rows.filter(r=>
      (f.gpu==="All"||r.gpu===f.gpu) &&
      (f.region==="All"||r.region===f.region) &&
      (f.type==="All"||r.type===f.type) &&
      (f.duration==="All"||r.duration===f.duration) &&
      (f.count==="All"|| String(r.count)===String(f.count))
    );
  }

  function hydrateAll(){
    const rows=applyFilters(state.scores).sort(byNumAsc("price"));
    document.getElementById("kpi_rows").textContent = rows.length;

    if(rows.length){
      const lo=rows[0];
      document.getElementById("kpi_low").textContent=fmt.money(lo.price);
      document.getElementById("kpi_low_sub").textContent=`${lo.provider} · ${lo.region} · ${lo.gpu} (${lo.type})`;
      const prices=rows.map(r=>r.price).filter(isFinite).sort((a,b)=>a-b);
      const mid=prices[Math.floor(prices.length/2)];
      document.getElementById("kpi_med").textContent=fmt.money(mid);
      document.getElementById("kpi_med_sub").textContent=`${rows.length} quotes`;
      document.getElementById("kpi_prov").textContent=uniq(rows.map(r=>r.provider)).length;
    }else{
      ["kpi_low","kpi_med","kpi_prov"].forEach(id=>document.getElementById(id).textContent="–");
      document.getElementById("kpi_low_sub").textContent="";
      document.getElementById("kpi_med_sub").textContent="";
    }

    // Leaderboard
    document.querySelector("#tbl_leader tbody").innerHTML = rows.map(r=>`
      <tr>
        <td>${r.provider}</td><td>${r.region}</td><td>${r.gpu}</td>
        <td><span class="pill">${r.type}</span></td>
        <td>${r.duration||"–"}</td>
        <td>${r.count!=null? r.count : "–"}</td>
        <td class="right">${fmt.money(r.price)}</td>
        <td class="right">${r.score!=null? Number(r.score).toFixed(1):"–"}</td>
        <td class="right">${fmt.date(r.ts)}</td>
      </tr>`).join("");

    // ROI table (improved: remove When, sort by Total ↑, add relative bar + "best" badge)
    const roi = [...state.roi].filter(r=>isFinite(r.total));
    roi.sort((a,b)=> a.total - b.total);
    const minT = roi.length ? roi[0].total : 0;
    const maxT = roi.length ? roi[roi.length-1].total : 1;
    const span  = Math.max(1, maxT - minT);

    document.getElementById("roiMeta").textContent = roi.length ? `sorted by total cost ↑ · ${roi.length} rows` : "no rows";

    document.querySelector("#tbl_roi tbody").innerHTML = roi.map((r,i)=>{
      const w = Math.max(6, Math.round(((r.total - minT)/span) * 100)); // keep a visible sliver
      const best = i===0 ? `<span class="badge best">best</span>` : "";
      return `<tr title="relative vs cheapest: ${w}%">
        <td>${r.gpu}</td><td>${r.count}</td><td>${r.duration}</td>
        <td>${r.provider} ${best}</td><td>${r.region}</td>
        <td class="right">${fmt.money(r.p)}</td>
        <td class="right">
          ${fmt.money0(r.total)}
          <div class="barWrap"><div class="bar" style="width:${w}%"></div></div>
        </td>
      </tr>`;
    }).join("");

    // Snapshot
    const cbody=document.querySelector("#tbl_comp tbody");
    cbody.innerHTML = state.snap.map(r=>{
      const lo = r.price_lo ?? r.price_lo_usd ?? r.lo;
      const md = r.price_md ?? r.price_md_usd ?? r.md;
      const hi = r.price_hi ?? r.price_hi_usd ?? r.hi;
      return `<tr>
        <td>${r.gpu_model || r.gpu || ""}</td>
        <td>${r.provider_type || r.provider_type_label || ""}</td>
        <td>${r["$/GPU-hr"] || (lo && hi ? `$${lo}–$${hi}`:"")}</td>
        <td>${r.TOTAL || r.total || ""}</td>
        <td class="right">${lo??""}</td>
        <td class="right">${md??""}</td>
        <td class="right">${hi??""}</td>
        <td class="right">${r.term_hours || r.term_hrs || ""}</td>
        <td class="right">${r.gpu_count || r.gpus || ""}</td>
        <td>${r.used_region || r.region || ""}</td>
        <td class="right">${r.n_quotes || r.quotes || ""}</td>
        <td>${r.source || ""}</td>
      </tr>`;
    }).join("");

    // Pred tiles
    const pp = state.predict||{};
    const moneyOrDash = v => (v==null||isNaN(v)) ? "–" : `$${Number(v).toFixed(2)}`;
    document.getElementById("p10").textContent  = moneyOrDash(pp.p10);
    document.getElementById("p25").textContent  = moneyOrDash(pp.p25);
    document.getElementById("p50").textContent  = moneyOrDash(pp.p50);
    document.getElementById("p7590").textContent= `${moneyOrDash(pp.p75||pp.p50)} / ${moneyOrDash(pp.p90)}`;
  }

  // ---------------------- QUICK CALC ----------------------
  function initQuickCalc(){
    const gpus = uniq(state.scores.map(r=>r.gpu)).sort();
    const regs = uniq(state.scores.map(r=>r.region)).sort();

    function set(el, arr){ el.innerHTML = arr.map(v=>`<option>${v}</option>`).join(""); }
    const qc_gpu   = document.getElementById("qc_gpu");
    const qc_region= document.getElementById("qc_region");
    const qc_count = document.getElementById("qc_count");
    const qc_dur   = document.getElementById("qc_dur");

    set(qc_gpu, gpus);
    set(qc_region, regs);
    set(qc_count, [8,16,32,64]);
    set(qc_dur, ["1 hour","1 day","1 week","1 month"]);

    qc_gpu.value   = gpus.includes("H100") ? "H100" : (gpus[0]||"");
    qc_region.value= regs.includes("Global") ? "Global" : (regs[0]||"");
    qc_count.value = "8";
    qc_dur.value   = "1 hour";

    document.getElementById("btnCalc").onclick = runQuickCalc;
    runQuickCalc(); // render once on load
  }

  function durToHours(s){
    const v = String(s||"").toLowerCase();
    if (v.includes("month")) return 24*30;
    if (v.includes("week"))  return 24*7;
    if (v.includes("day"))   return 24;
    return 1; // hour
  }

  function runQuickCalc(){
    const gpu  = document.getElementById("qc_gpu").value;
    let   reg  = document.getElementById("qc_region").value;
    const cnt  = Number(document.getElementById("qc_count").value||0);
    const hrs  = durToHours(document.getElementById("qc_dur").value);
    const usePred = document.getElementById("qc_usePred").checked;

    // Primary: exact region
    let rows = state.scores.filter(r=> r.gpu===gpu && r.region===reg && /On-Demand/i.test(r.type));
    // If empty, relax region to any with data (and update select to reflect what we actually used)
    if (!rows.length){
      const any = state.scores.find(r=> r.gpu===gpu && /On-Demand/i.test(r.type));
      if (any){ reg = any.region; rows = state.scores.filter(r=> r.gpu===gpu && r.region===reg && /On-Demand/i.test(r.type));
               document.getElementById("qc_region").value = reg; logDbg(`QC: no rows for chosen region, using ${reg}`); }
    }

    const byProv = new Map();
    rows.forEach(r=>{
      const k=r.provider+"|"+r.region;
      const best=byProv.get(k);
      if(!best || r.price<best.price) byProv.set(k,r);
    });

    let out=[...byProv.values()].map(r=>({
      provider:r.provider, region:r.region, price:r.price, total:r.price*cnt*hrs, src:"observed"
    }));

    if(usePred && state.predict && state.predict.gpu_model===gpu && state.predict.region===reg && state.predict.p50){
      out.push({ provider:"Predicted (P50)", region:reg, price:Number(state.predict.p50), total:Number(state.predict.p50)*cnt*hrs, src:"predicted" });
    }

    out.sort((a,b)=>a.total-b.total);
    document.querySelector("#tbl_qc tbody").innerHTML = out.map(r=>`
      <tr>
        <td>${r.provider}</td><td>${r.region}</td>
        <td class="right">${fmt.money(r.price)}</td>
        <td class="right">${fmt.money0(r.total)}</td>
        <td class="right"><span class="badge">${r.src}</span></td>
      </tr>`).join("");
  }

  // ---------------------- PROVIDER HISTORY ----------------------
  const historyCache = new Map();

  function providerToCandidates(name){
    const base = name.toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
    const parts = base.split(/\s+/);
    const glued = [ parts.join(''), parts.join('-'), parts.join('_') ];
    const extras = [];
    if (base.includes('lambda')) extras.push('lambdalabs','lambda_labs','lambda-labs','lambda');
    if (base.includes('crusoe')) extras.push('crusoecloud','crusoe_cloud','crusoe-cloud','crusoe');
    if (base.includes('vast'))   extras.push('vastai','vast_ai','vast-ai');
    if (base.includes('voltage'))extras.push('voltagepark','voltage_park','voltage-park');
    if (base.includes('tensor')) extras.push('tensordock','tensor_dock','tensor-dock');
    if (base.includes('runpod')) extras.push('runpod');
    if (base.includes('paperspace')) extras.push('paperspace');
    if (base.includes('nebius')) extras.push('nebius');
    if (base.includes('sfcompute') || base.includes('sf compute')) extras.push('sfcompute','sf-compute','sf_compute');
    if (base.includes('hydra') || base.includes('brokkr')) extras.push('brokkr','hydra_host','hydra-host');
    const names = [...new Set([...glued, ...extras])];
    const files = [];
    names.forEach(n=>{ files.push(`${n}_history.csv`, `${n}-history.csv`, `${n}.csv`); });
    return files;
  }

  function initHistoryUI(){
    const providers = uniq(state.scores.map(r=>r.provider)).sort();
    const sel = document.getElementById("hist_provider");
    sel.innerHTML = providers.map(p=>`<option>${p}</option>`).join("");
    sel.value = providers[0] || "";

    // default GPU tied to top filter (prefer H100)
    document.getElementById("hist_gpu").value = state.filters.gpu==="H200" ? "H200" : "H100";

    ["hist_provider","hist_gpu","hist_dur","hist_cnt","hist_range"].forEach(id=>{
      document.getElementById(id).addEventListener("change", renderHistory);
    });
    renderHistory();
  }

  async function loadHistoryForProvider(provider){
    if (historyCache.has(provider)) return historyCache.get(provider);
    const candidates = providerToCandidates(provider);
    for (const file of candidates){
      try{
        const txt = await (await getHistory(file)).text();
        const rows = parseCSV(txt).map(r=>{
          const price = numify(r.price_hourly_usd ?? r.price_usd ?? r.price ?? r.effective_price_usd_per_gpu_hr);
          const ts    = r.fetched_at_utc || r.timestamp || r.fetched_at || r.when || r.ts;
          const gpu   = r.gpu_model || r.gpu || r.model;
          const type  = r.type || r.instance_type || r.category;
          const dur   = r.duration || r.term || r.runtime;
          const cnt   = r.gpu_count ? Number(r.gpu_count) : (r.count ? Number(r.count) : null);
          return { provider, region:r.region, gpu, type, duration:dur, count:cnt, price, ts };
        }).filter(r=> r.ts && isFinite(r.price));
        logDbg(`history(${provider}): using file ${file} (${rows.length} rows)`);
        historyCache.set(provider, rows);
        return rows;
      }catch(e){ /* try next */ }
    }
    logDbg(`history(${provider}): no file found`);
    historyCache.set(provider, []);
    return [];
  }

  function startOfTodayLocal(){
    const d=new Date(); d.setHours(0,0,0,0); return d.getTime();
  }

  async function renderHistory(){
    const prov = document.getElementById("hist_provider").value;
    const gpu  = document.getElementById("hist_gpu").value;
    const dur  = document.getElementById("hist_dur").value;
    const cnt  = document.getElementById("hist_cnt").value;
    const rng  = document.getElementById("hist_range").value;

    let rows = await loadHistoryForProvider(prov);
    // base: GPU & prefer On-Demand
    let view = rows.filter(r=> r.gpu===gpu && (!r.type || /On-Demand/i.test(r.type)));
    if(dur!=="All") view = view.filter(r=> String(r.duration||"").toLowerCase()===dur.toLowerCase());
    if(cnt!=="All") view = view.filter(r=> String(r.count)===String(cnt));
    if(!view.length) view = rows.filter(r=> r.gpu===gpu); // relax

    // range selection
    if (rng!=="all"){
      if (rng==="today"){
        const cut = startOfTodayLocal();
        view = view.filter(r=> new Date(r.ts).getTime() >= cut);
      }else{
        const days = Number(rng);
        const cut = Date.now() - days*24*3600*1000;
        view = view.filter(r=> new Date(r.ts).getTime() >= cut);
      }
    }

    view.sort((a,b)=> new Date(a.ts)-new Date(b.ts));
    const labels=view.map(r=> String(r.ts).replace("T"," ").replace("Z",""));
    const data  =view.map(r=> r.price);

    const ctx=document.getElementById("histChart").getContext("2d");
    if (window._histChart) window._histChart.destroy();
    window._histChart = new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{ label:`${prov} · ${gpu}${dur!=="All" ? " · "+dur : ""}${cnt!=="All" ? " · "+cnt+" GPUs" : ""}`, data, tension:0.25 }]},
      options:{ responsive:true, plugins:{ legend:{display:true}}, scales:{ y:{ ticks:{ callback:v=>"$"+Number(v).toFixed(2)}}, x:{ ticks:{ autoSkip:true, maxRotation:0 }}}}
    });

    logDbg(`history filtered: ${view.length} points (${rng})`);
  }

  // ---------------------- BOOT ----------------------
  loadAll();
})();
</script>
</body>
</html>





