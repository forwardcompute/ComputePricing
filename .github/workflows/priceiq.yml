name: build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"   # every 4 hours

concurrency:
  group: priceiq-build
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # notebook + scraping deps (as before)
          pip install papermill jupyter ipykernel nest-asyncio aiohttp requests beautifulsoup4 lxml pandas numpy
          # headless browser (if your notebook needs it)
          pip install playwright
          python -m playwright install --with-deps chromium
          # kernel for papermill
          python -m ipykernel install --user --name python3

      - name: Build data (scrape + aggregate)
        run: |
          # Execute your single notebook; outputs land under docs/data/**
          papermill "scrape+formula.ipynb" "docs/last_run.ipynb" -k python3
          echo "Listing derived outputs after scrape:"
          ls -lah docs/data || true
          ls -lah docs/data/derived || true
          ls -lah docs/data/history || true

      - name: Train price bands from history (EWMA + bootstrap)
        run: |
          # Produces docs/data/derived/price_predict_snapshot.json and forecast.csv
          python train_benchmark.py \
            --gpu H100 --region Global --type "On-Demand" --duration "1h" --count 8 \
            --history-root docs/data/history --out-root docs/data/derived --lookback-days 14 || echo "training step returned non-zero (continuing)"
          echo "Forecast snapshot:"
          cat docs/data/derived/price_predict_snapshot.json || true
          echo "Derived after training:"
          ls -lah docs/data/derived || true

      - name: Commit dashboard data (derived + history + latest)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Price-IQ: update data (derived + history + latest + forecast)"
          file_pattern: |
            docs/data/**
            docs/last_run.ipynb



